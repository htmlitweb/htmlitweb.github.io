<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLIT</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/6379/6379850.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base styles for a deep dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a; /* Very dark background */
            color: #e6edf3; /* Light text for contrast */
            transition: background-color 0.3s ease, color 0.3s ease, font-size 0.3s ease; /* Smooth transitions for theme/text size */
        }
        /* New class to prevent body scrolling when a fullscreen modal is active */
        body.modal-fullscreen-active {
            overflow: hidden;
        }

        .gradient-bg {
            background-color: #0a0a0a; /* Consistent very dark background */
        }
        /* Main content area and header background */
        .main-bg {
            background-color: rgba(15, 15, 15, 0.9); /* Slightly lighter than body, with transparency */
            backdrop-filter: blur(12px); /* Increased blur for more depth */
            border: 1px solid rgba(40, 40, 40, 0.6); /* Subtle, darker border */
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); /* More pronounced shadow */
        }
        /* Card specific styling for posts */
        .card-bg {
            background-color: #1c1c1c; /* Darker card background */
            border: 1px solid #3a3a3a; /* Darker, more defined border */
            border-radius: 24px; /* More rounded corners - Increased from 12px */
            transition: all 0.3s ease-in-out; /* Keep general transition */
            opacity: 0.98; /* Almost opaque */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Initial shadow */
        }
        .card-bg:hover {
            transform: translateY(-4px); /* Reduced lift effect for subtlety */
            opacity: 1;
            box-shadow: 0 10px 20px rgba(0,0,0,0.6); /* Stronger shadow on hover */
            border-color: #00bcd4; /* Vibrant teal border on hover */
        }
        /* Removed active state for a less frequent click animation */

        /* Specific styles for HTML Game cards */
        .card-html-game {
            border-color: #007bff; /* Blue border for HTML Games */
        }
        .card-html-game:hover {
            border-color: #00bcd4; /* Teal border on hover for HTML Games */
        }
        /* Specific styles for Devlog cards */
        .card-devlog {
            border-color: #ffc107; /* Yellow/Amber border for devlogs */
        }
        .card-devlog:hover {
            border-color: #00bcd4; /* Teal border on hover for devlogs */
        }

        /* Input field styling */
        .input-bg {
            background-color: #1a1a1a; /* Dark input background */
            border: 1px solid #3a3a3a; /* Dark input border */
            border-radius: 8px; /* Rounded inputs */
            transition: all 0.3s ease-in-out;
            color: #e6edf3; /* Text color in input */
        }
        .input-bg:focus-within, .input-bg:focus {
            border-color: #00bcd4; /* Vibrant teal focus */
            box-shadow: 0 0 0 4px rgba(0, 188, 212, 0.5); /* Teal glow on focus */
            outline: none; /* Remove default outline */
        }
        /* Primary button styling */
        .btn-primary {
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Blue to teal gradient */
            border-radius: 8px; /* Rounded buttons */
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); /* Initial shadow */
            border: none;
            opacity: 0.95;
            font-weight: 600; /* Slightly bolder text */
        }
        .btn-primary:hover {
            transform: translateY(-3px); /* Lift effect on hover */
            opacity: 1;
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.6); /* Stronger blue shadow on hover */
        }
        /* Navigation item styling */
        .nav-item {
            transition: color 0.3s ease-in-out;
            padding: 8px 0; /* Add padding for better click area */
        }
        .nav-item.active {
            color: #00bcd4; /* Vibrant teal for active tab */
            position: relative;
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -6px; /* Slightly lower underline */
            left: 0;
            width: 100%;
            height: 3px; /* Thicker underline */
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Matching gradient underline */
            border-radius: 2px; /* Rounded ends for underline */
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px; /* Wider scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; /* Darker track */
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #007bff, #00bcd4); /* Blue to teal gradient thumb */
            border-radius: 50px; /* Fully rounded thumb */
        }
        /* Loader animation */
        .loader {
            border: 5px solid rgba(255,255,255,0.2);
            border-top: 5px solid #00bcd4; /* Teal loader */
            border-radius: 50%;
            width: 60px; /* Larger loader */
            height: 60px;
            animation: spin 1s linear infinite;
        }
        /* Spinner for load more button */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal backdrop and positioning */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9); /* Very dark, almost opaque backdrop */
            backdrop-filter: blur(12px); /* More blur for depth */
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            transition: all 0.3s ease-in-out; /* Smooth transition for fullscreen */
            overflow-y: auto; /* Allow content inside modal to scroll */
        }
        /* Fullscreen styles for the modal */
        .modal.fullscreen {
            top: 0;
            left: 0;
            width: 100vw !important; /* Override specific width */
            height: 100vh !important; /* Override specific height */
            transform: none; /* Remove translate */
            border-radius: 0; /* Remove rounded corners */
            padding: 1rem; /* Adjust padding for fullscreen */
            max-width: none !important; /* Remove max-width in fullscreen */
            max-height: none !important; /* Remove max-height in fullscreen */
        }
        .modal-backdrop.fullscreen {
            background-color: #0a0a0a; /* Solid background for fullscreen */
            backdrop-filter: none; /* Remove blur for fullscreen */
        }

        /* Custom Checkbox (general style) */
        .custom-checkbox input { display: none; }
        .custom-checkbox span {
            padding: 10px 15px; /* More padding */
            border-radius: 8px; /* More rounded */
            border: 1px solid #3a3a3a; /* Darker border */
            background-color: #1a1a1a; /* Darker background */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex; /* Use flexbox for centering */
            align-items: center; /* Vertically center content */
            justify-content: center;
            text-align: center;
            color: #b0b0b0; /* Lighter text color */
            font-weight: 500;
        }
        /* Specific style for genre/platform checkboxes to enforce height */
        .grid-checkbox-uniform .custom-checkbox span {
            min-height: 60px; /* Standardize height for two lines of text */
            line-height: 1.2; /* Ensure consistent line height */
        }
        .custom-checkbox input:checked + span {
            background: linear-gradient(90deg, #007bff, #00bcd4); /* Blue to teal gradient */
            color: white;
            border-color: #00bcd4; /* Teal border */
            box-shadow: 0 2px 10px rgba(0, 188, 212, 0.5); /* Teal shadow */
        }
        /* Highlight for searched genres */
        .custom-checkbox span.genre-highlight {
            background-color: #333; /* Darker background for highlight */
            border-color: #00bcd4; /* Teal border for highlight */
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.5); /* Subtle teal glow */
            color: #e6edf3; /* Ensure text is readable */
        }
        /* Custom Select (for dropdowns) */
        .custom-select { position: relative; }
        .custom-select select {
            appearance: none; -webkit-appearance: none;
            padding-right: 2.5rem; /* Space for arrow */
        }
        .custom-select::after {
            content: '\f078'; /* Font Awesome chevron-down icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            pointer-events: none;
            color: #8b949e;
        }

        /* Improved card styling for media thumbnails */
        .card-bg .thumbnail-container {
            width: 100%;
            height: 192px; /* h-48 */
            overflow: hidden;
            background-color: #101010; /* Very dark background for empty media */
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #2a2a2a; /* Separator for media */
            position: relative; /* For play button overlay */
            border-radius: 0px 0px 0 0; /* Rounded top corners for thumbnail */
        }

        /* Ensure image and iframe inside thumbnail container are NOT rounded themselves */
        /* Added !important to ensure override */
        .card-bg .thumbnail-container img,
        .card-bg .thumbnail-container iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0 !important; /* Explicitly remove rounding from the media element itself */
        }
        /* Styling for HTML game iframe preview */
        .html-game-preview-iframe {
            width: 100%;
            height: 400px; /* Fixed height for preview */
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            background-color: #000; /* Black background for games */
        }

        /* New: Aspect ratio container for HTML game preview */
        .html-game-preview-aspect-ratio {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio (height / width * 100%) */
            overflow: hidden;
            border-radius: 8px;
            background-color: #000; /* Black background for games */
            border: 1px solid #3a3a3a;
        }

        .html-game-preview-aspect-ratio iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }


        /* Play button overlay for YouTube thumbnails */
        .play-button-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(9, 148, 144, 0.8), rgba(40, 170, 219, 0.8)); /* Faded blue-teal */
            border-radius: 50%;
            width: 60px; /* Slightly larger but cleaner */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease; /* Keep transition for scale effect */
            box-shadow: 0 0 8px rgba(40, 170, 219, 0.3); /* Subtle blue glow */
            backdrop-filter: blur(2px); /* Optional glassy effect */
            z-index: 10; /* Ensure it's above the image */
        }

        .play-button-overlay:hover {
            transform: translate(-50%, -50%) scale(1.1); /* Only scale on hover, removed pulse */
        }

        /* Play icon style */
        .play-button-overlay i {
            color: white;
            font-size: 2rem; /* Slightly smaller than before for balance */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 1;
        }

        /* Removed @keyframes pulse as it's no longer used */

        /* Z-index for dropdown to appear above other elements */
        #more-dropdown {
            z-index: 60; /* Ensure this is higher than other elements like sort-by select */
        }

        /* New styles for video modal */
        .video-modal-content {
            border: 2px solid #00bcd4; /* Greenish/blue border */
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.7); /* Matching glow */
        }

        /* Styles for the back and share buttons in the modal */
        .modal-action-btn {
            background-color: transparent; /* Keep background transparent */
            border: none; /* Remove border */
            border-radius: 9999px; /* Fully rounded */
            width: 40px; /* Fixed width */
            height: 40px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af; /* Default grey color (text-gray-400 equivalent) */
            font-size: 1.25rem; /* Icon size */
            transition: color 0.2s ease-in-out; /* Only transition color */
            box-shadow: none; /* Ensure no shadow */
        }

        .modal-action-btn:hover {
            background-color: transparent; /* Ensure background remains transparent */
            border-color: transparent; /* Ensure border remains transparent */
            color: #ffffff; /* White icon on hover */
            transform: none; /* Remove any scale effect */
            box-shadow: none; /* Ensure no shadow on hover */
        }

        .modal-action-btn:active {
            transform: none; /* Remove any press effect */
            box-shadow: none; /* Ensure no shadow on active */
        }

        /* Theme-specific styles */
        body.light-mode {
            background-color: #fcfcfc; /* Very light, almost white */
            color: #212121; /* Darker text for better readability */
        }
        body.light-mode .main-bg {
            background-color: rgba(255, 255, 255, 0.98); /* Near white, slight transparency */
            border: 1px solid #e8e8e8; /* Very light border */
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); /* Soft, subtle shadow */
        }
        body.light-mode .card-bg {
            background-color: #ffffff; /* Pure white cards */
            border: 1px solid #f5f5f5; /* Extremely light border */
            box-shadow: 0 1px 4px rgba(0,0,0,0.01); /* Very subtle shadow */
        }
        body.light-mode .card-bg:hover {
            border-color: #00bcd4; /* Teal border on hover */
            box-shadow: 0 4px 10px rgba(0,0,0,0.04); /* Slightly more visible shadow */
        }
        body.light-mode .input-bg {
            background-color: #ffffff; /* White input background */
            border: 1px solid #e0e0e0; /* Light gray border */
            color: #212121; /* Dark text */
        }
        body.light-mode .input-bg:focus-within, body.light-mode .input-bg:focus {
            border-color: #00bcd4; /* Teal focus */
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1); /* Soft teal glow */
        }
        body.light-mode .text-gray-300 { color: #4a4a4a; } /* Darker gray for better readability */
        body.light-mode .text-gray-400 { color: #666666; }
        body.light-mode .text-gray-500 { color: #888888; }
        body.light-mode .text-white { color: #212121; } /* Header text in light mode */
        body.light-mode .bg-[#1a1a1a] { background-color: #f0f0f0; } /* For comments background, very light */
        body.light-mode .border-gray-700 { border-color: #e0e0e0; } /* Lighter border */
        body.light-mode .bg-gray-700 { background-color: #e8e8e8; color: #444444; } /* Tag background */
        body.light-mode .bg-purple-700 { background-color: #f0e6ff; color: #7a3ed6; } /* Purple tag */
        body.light-mode .bg-blue-700 { background-color: #e0f7fa; color: #007bff; } /* Blue tag */
        body.light-mode .bg-green-700 { background-color: #e6ffe6; color: #008000; } /* Green tag */
        body.light-mode .text-red-500 { color: #ef4444; } /* Ensure like button color is visible */
        body.light-mode .text-blue-500 { color: #3b82f6; } /* Ensure edit button color is visible */
        body.light-mode .modal-action-btn { color: #6b7280; } /* Darker icon color */
        body.light-mode .modal-action-btn:hover { color: #212121; } /* Darker icon on hover */
        
        /* New: Darker hover effect for like/comment/view/visit buttons in light mode */
        body.light-mode .like-btn:hover, 
        body.light-mode .comment-btn:hover,
        body.light-mode .inline-flex .hover\:text-white:hover { /* Target the parent span's hover */
            color: #007bff; /* A distinct blue for hover */
        }

        /* Light mode styling for unselected custom checkboxes */
        body.light-mode .custom-checkbox span {
            background-color: #f0f0f0; /* Light gray background */
            border-color: #d0d0d0; /* Slightly darker border */
            color: #4a4a4a; /* Darker text for readability */
        }
        body.light-mode .custom-checkbox input:checked + span {
            background: linear-gradient(90deg, #007bff, #00bcd4);
            color: white;
            border-color: #00bcd4;
            box-shadow: 0 2px 10px rgba(0, 188, 212, 0.5);
        }

        /* Text size classes */
        body.text-sm { font-size: 0.875rem; } /* 14px */
        body.text-base { font-size: 1rem; }    /* 16px (default) */
        body.text-lg { font-size: 1.125rem; }  /* 18px */

        /* Animations toggle */
        body.no-animations * {
            transition: none !important;
            animation: none !important;
        }
    </style>
</head>
<body>

    <div id="app" class="max-w-7xl mx-auto px-4 py-4 sm:px-6">
        <header class="flex justify-between items-center py-4 px-4 main-bg rounded-lg shadow-lg">
            <h1 class="text-2xl sm:text-3xl font-bold text-white tracking-wider">HTML<span class="text-[#00bcd4]">IT</span></h1>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition active" data-tab="community">Community</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="html-games">HTML Games</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="devlogs">Devlogs</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="post">Post</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="search">Search</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="my-posts">My Posts</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="about">About</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="rules">Rules</a>
                <a href="javascript:void(0)" class="nav-item text-lg font-semibold hover:text-[#00bcd4] transition" data-tab="settings">Settings</a>
            </nav>
            <div class="md:hidden">
                <button id="mobile-menu-btn"><i class="fas fa-bars text-2xl"></i></button>
            </div>
        </header>
        <div id="mobile-menu" class="hidden md:hidden main-bg rounded-lg mt-2 p-4">
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="community">Community</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="html-games">HTML Games</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="devlogs">Devlogs</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="post">Post</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="search">Search</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="my-posts">My Posts</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="about">About</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="rules">Rules</a>
             <a href="javascript:void(0)" class="block py-2 text-center nav-item" data-tab="settings">Settings</a>
        </div>


        <main id="main-content" class="mt-8">
            <div id="loader" class="flex justify-center items-center h-64"><div class="loader"></div></div>
            <div id="content-community" class="tab-content"></div>
            <div id="content-html-games" class="tab-content hidden"></div>
            <div id="content-devlogs" class="tab-content hidden"></div>
            <div id="content-post" class="tab-content hidden"></div>
            <div id="content-search" class="tab-content hidden"></div>
            <div id="content-my-posts" class="tab-content hidden"></div>
            <div id="content-about" class="tab-content hidden"></div>
            <div id="content-rules" class="tab-content hidden"></div>
            <div id="content-settings" class="tab-content hidden"></div>
        </main>
    </div>
    
    <div id="post-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div id="modal-content" class="modal w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl h-5/6 main-bg rounded-lg shadow-lg p-4 sm:p-6 overflow-y-auto"></div>
    </div>
    <div id="alert-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-11/12 max-w-sm main-bg rounded-lg shadow-lg p-6 text-center">
            <p id="alert-message" class="mb-6"></p>
            <button id="alert-ok-btn" class="btn-primary text-white font-bold py-2 px-6 rounded-md">OK</button>
        </div>
    </div>
    <div id="confirm-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-11/12 max-w-sm main-bg rounded-lg shadow-lg p-6 text-center">
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md">Yes</button>
                <button id="confirm-no-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md">No</button>
            </div>
        </div>
    </div>

	<!-- New Video Modal -->
	<div id="video-modal" class="hidden">
		<div class="modal-backdrop"></div>
		<div id="video-modal-content" class="modal w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl main-bg rounded-lg shadow-lg p-4 sm:p-6 video-modal-content">
			<div class="flex justify-between mb-4">
                <button id="close-video-modal-btn" class="modal-action-btn"><i class="fa-solid fa-xmark"></i></button>
                <button id="fullscreen-video-toggle-btn" class="modal-action-btn"><i class="fas fa-expand"></i></button>
			</div>
			<div class="aspect-video w-full rounded-md overflow-hidden relative">
				<iframe id="video-player-iframe" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
			</div>
		</div>
	</div>

    <!-- New Confirmation Input Modal -->
    <div id="confirm-input-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal w-11/12 max-w-md main-bg rounded-lg shadow-lg p-6 text-center">
            <p id="confirm-input-message" class="mb-4 text-gray-300"></p>
            <p id="confirm-input-expected-text" class="mb-4 text-gray-200 font-semibold break-words"></p>
            <input type="text" id="confirm-input-field" class="w-full p-3 input-bg rounded-md mb-6 text-center" placeholder="Type here to confirm...">
            <div class="flex justify-center gap-4">
                <button id="confirm-input-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md" disabled>Confirm</button>
                <button id="confirm-input-no-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md">Cancel</button>
            </div>
        </div>
    </div>

    <!-- NEW: Dedicated HTML Game Play Modal -->
    <div id="game-play-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div id="game-play-modal-content" class="modal w-11/12 md:w-3/4 lg:w-2/3 max-w-4xl main-bg rounded-lg shadow-lg p-4 sm:p-6 video-modal-content">
            <div class="flex justify-between mb-4">
                <button id="close-game-play-modal-btn" class="modal-action-btn"><i class="fa-solid fa-xmark"></i></button>
                <button id="fullscreen-game-iframe-toggle-btn" class="modal-action-btn"><i class="fas fa-expand"></i></button>
            </div>
            <div class="aspect-video w-full rounded-md overflow-hidden relative">
                <iframe id="game-iframe-player" class="w-full h-full" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-media; gyroscope; picture-in-picture; web-share" allowfullscreen sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-pointer-lock allow-downloads"></iframe>
            </div>
        </div>
    </div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, serverTimestamp, query, where, getDocs, limit, orderBy, startAfter, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration - UPDATED AS REQUESTED
        const firebaseConfig = {
            apiKey: "AIzaSyApRnTCA3jtvBX3YhsvdS8HWXnCd2Iqt8A",
            authDomain: "posthtml-541f7.firebaseapp.com",
            projectId: "posthtml-541f7", 
            storageBucket: "posthtml-541f7.firebasestorage.app",
            messagingSenderId: "1076783896793",
            appId: "1:1076783896793:web:440e4b01907e41074446c8",
            measurementId: "G-STGYDD7WQJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // Analytics initialized here

        // Using projectId from the hardcoded config as the appId for Firestore paths.
        // This is crucial for matching the Firestore security rules.
        const appId = firebaseConfig.projectId; 

        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allFetchedPosts = []; // This will now hold ALL posts fetched by onSnapshot
        let isAuthReady = false; // Flag to ensure Firestore operations wait for authentication to complete.
        let displayLimit = 9; // Number of posts to load per page initially
        const postsPerPage = 9; // Number of posts to load per page
        let currentSortBy = 'newest'; // Default sort order for community feed
        // Removed currentPricingFilter as pricing is no longer a filter for HTML Games
        let currentAiContentFilter = 'all'; // New: Default AI content filter

        // Global array to store selected genres, persisting across search filters
        let selectedGenres = []; 
        
        // Define genres globally so renderGenreCheckboxes can access it
        const genres = ["Action", "Adventure", "RPG", "Strategy", "Simulation", "Puzzle", "Platformer", "Shooter", "Fighting", "Stealth", "Survival", "Horror", "Visual Novel", "Rhythm", "Sports", "Racing", "MMO", "Indie", "Casual", "Arcade", "Language", "Card & Board", "Roguelike", "Roguelite", "Metroidvania", "Souls-like", "CRPG", "JRPG", "ARPG", "Tactical RPG", "4X", "RTS", "Tower Defense", "Farming Sim", "Life Sim", "Point & Click", "Bullet Hell", "Hack and Slash", "Sandbox", "Open World", "Deck-builder", "City-builder", "Immersive Sim", "Walking Simulator", "Party Game", "Trivia", "Co-op", "Multiplayer", "Singleplayer", "Early Access", "Full Release", "Demo", "Free to Play", "Pay What You Want", "Puzzle-Platformer", "Survival Horror", "Metroidvania-lite", "Story-Rich", "Procedural Generation", "Pixel Art", "Voxel Art", "3D", "2D", "Top-Down", "Side-Scroller", "First-Person", "Third-Person", "Abstract", "Minimalist", "Retro", "Futuristic", "Fantasy", "Sci-Fi", "Historical", "Modern", "Comedy", "Drama", "Mystery", "Thriller", "Educational", "Relaxing", "Challenging", "Fast-Paced", "Slow-Paced", "Exploration", "Crafting", "Building", "Management", "Deckbuilding Roguelike", "Visual Novel RPG", "Action-Adventure", "Strategy RPG", "Turn-Based Strategy", "Real-Time Strategy", "Tactical Shooter", "Arena Shooter", "Battle Royale", "Dungeon Crawler", "Endless Runner", "Idle Game", "Incremental Game", "Interactive Fiction", "Music", "Narrative", "Party", "Pinball", "Platform Fighter", "Precision Platformer", "Programming", "Quick-Time Event", "Quiz", "Rogue-lite", "Role-Playing", "Sandbox RPG", "Sci-Fi RPG", "Shoot 'em Up", "Simulation RPG", "Social Deduction", "Space", "Steampunk", "Story", "Superhero", "Surreal", "Tabletop", "Team-Based", "Text Adventure", "Time Management", "Top-Down Shooter", "Trading", "Train", "Transhumanism", "Travel", "Trigonometry", "Typing", "Uplifting", "Vampire", "Vehicular Combat", "Vertical Shooter", "Visual Novel Horror", "Visual Novel Mystery", "Visual Novel Sci-Fi", "Visual Novel Slice of Life", "Visual Novel Thriller", "Visual Novel Comedy", "Visual Novel Drama", "Visual Novel Fantasy", "Visual Novel Romance", "War", "Western", "Word Game", "Wrestling", "Cooking", "Zombies", "Zoo", "Zork-like"];

        // User settings state - now initialized from local storage or defaults
        let userSettings = {
            theme: 'system', // 'system', 'light', 'dark'
            textSize: 'base', // 'sm', 'base', 'lg'
            animations: true, // true, false
            showPostCounts: true, // true, false
            defaultPostType: 'HTML Game', // Changed from 'Game Promotion'
            defaultSortOrder: 'newest', // 'newest', 'popular', 'oldest', 'most-viewed', 'most-visited'
            defaultPostCountDisplay: 'abbreviated', // 'exact', 'abbreviated' - Default changed to 'abbreviated'
            modalFullscreen: false // New setting: automatically open modals in fullscreen
        };

        // Map to store last view timestamp for each post to prevent spamming views
        // Key: postId, Value: timestamp (Date.now())
        const lastViewTimestamps = new Map();
        const VIEW_COOLDOWN_MS = 10000; // 10 seconds cooldown for view increments

        // --- DOM ELEMENTS ---
        const loader = document.getElementById('loader');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        
        const contentCommunity = document.getElementById('content-community');
        const contentHtmlGames = document.getElementById('content-html-games'); // Changed from promos
        const contentDevlogs = document.getElementById('content-devlogs');
        const contentPost = document.getElementById('content-post');
        const contentSearch = document.getElementById('content-search');
        const contentMyPosts = document.getElementById('content-my-posts');
        const contentAbout = document.getElementById('content-about');
        const contentRules = document.getElementById('content-rules');
        const contentSettings = document.getElementById('content-settings');

        const postModal = document.getElementById('post-modal');
        const modalContent = document.getElementById('modal-content');
        const alertModal = document.getElementById('alert-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmInputModal = document.getElementById('confirm-input-modal');

        // New video modal elements
        const videoModal = document.getElementById('video-modal');
        const videoModalContent = document.getElementById('video-modal-content');
        const videoPlayerIframe = document.getElementById('video-player-iframe');
        const closeVideoModalBtn = document.getElementById('close-video-modal-btn');
        const fullscreenVideoToggleBtn = document.getElementById('fullscreen-video-toggle-btn');

        // NEW: HTML Game Play Modal Elements
        const gamePlayModal = document.getElementById('game-play-modal');
        const gamePlayModalContent = document.getElementById('game-play-modal-content');
        const gameIframePlayer = document.getElementById('game-iframe-player');
        const closeGamePlayModalBtn = document.getElementById('close-game-play-modal-btn');
        const fullscreenGameIframeToggleBtn = document.getElementById('fullscreen-game-iframe-toggle-btn');


        let editingPostId = null; // Stores the ID of the post currently being edited
        let isPostModalOpen = false; // Flag to prevent multiple modal instances


        // --- HELPER FUNCTIONS ---
        // Displays a custom alert message to the user.
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            alertModal.classList.remove('hidden');
            return new Promise(resolve => {
                document.getElementById('alert-ok-btn').onclick = () => {
                    alertModal.classList.add('hidden');
                    resolve();
                };
            });
        }

        // Displays a custom confirmation dialog to the user.
        function showConfirm(message) {
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            return new Promise(resolve => {
                document.getElementById('confirm-yes-btn').onclick = () => {
                    confirmModal.classList.add('hidden');
                    resolve(true);
                };
                document.getElementById('confirm-no-btn').onclick = () => {
                    confirmModal.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        // Displays a custom confirmation dialog with a text input.
        function showConfirmWithInput(message, expectedText) {
            const messageEl = document.getElementById('confirm-input-message');
            const expectedTextEl = document.getElementById('confirm-input-expected-text');
            const inputField = document.getElementById('confirm-input-field');
            const confirmBtn = document.getElementById('confirm-input-yes-btn');
            const cancelBtn = document.getElementById('confirm-input-no-btn');

            messageEl.textContent = message;
            expectedTextEl.textContent = `Type "${expectedText}" exactly to confirm:`;
            inputField.value = ''; // Clear previous input
            confirmBtn.disabled = true; // Disable confirm button initially
            confirmInputModal.classList.remove('hidden');

            return new Promise(resolve => {
                const inputListener = () => {
                    confirmBtn.disabled = (inputField.value !== expectedText);
                };

                inputField.addEventListener('input', inputListener);

                confirmBtn.onclick = () => {
                    inputField.removeEventListener('input', inputListener);
                    confirmInputModal.classList.add('hidden');
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    inputField.removeEventListener('input', inputListener);
                    confirmInputModal.classList.add('hidden');
                    resolve(false);
                };
            });
        }
        
        // Extracts the YouTube video ID from a given URL.
        function getYouTubeVideoId(url) {
            if (!url) return '';
            let videoId = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                } else if (urlObj.hostname.includes('youtu.be')) {
                    videoId = urlObj.pathname.slice(1);
                }
            } catch (e) { /* Invalid URL, videoId remains null */ }
            return videoId;
        }

        // Generates the YouTube thumbnail URL.
        function getYouTubeThumbnailUrl(videoId) {
            return videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : '';
        }

        // Generates the YouTube embed source URL.
        function getYouTubeEmbedSrc(videoId, autoplay = false) {
            return videoId ? `https://www.youtube.com/embed/${videoId}${autoplay ? '?autoplay=1' : ''}` : '';
        }

        // Loads the YouTube video by replacing the thumbnail with the iframe.
        function loadYouTubeVideo(containerElement, videoId) {
            console.log("loadYouTubeVideo called for videoId:", videoId, "on container:", containerElement);
            const embedSrc = getYouTubeEmbedSrc(videoId, true); // Autoplay when clicked
            if (embedSrc) {
                // Ensure the container has a defined height for the iframe to render correctly
                containerElement.innerHTML = `<iframe class="w-full h-full rounded-none" src="${embedSrc}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
                console.log("Iframe embedded:", embedSrc);
            } else {
                console.warn("No valid YouTube embed source generated for videoId:", videoId);
            }
        }

        // Opens the dedicated video modal
        function openVideoModal(videoId) {
            const embedSrc = getYouTubeEmbedSrc(videoId, true); // Always autoplay when opened via dedicated button
            if (embedSrc) {
                videoPlayerIframe.src = embedSrc; 
                videoModal.classList.remove('hidden');
                // Apply fullscreen if setting is enabled
                if (userSettings.modalFullscreen) {
                    toggleFullscreen(videoModalContent, true); // Pass true to force fullscreen on open
                }
            } else {
                showAlert("Could not play video: Invalid YouTube link.");
            }
        }

        // Closes the dedicated video modal
        function closeVideoModal() {
            videoModal.classList.add('hidden');
            videoPlayerIframe.src = ''; // Stop video playback by clearing src
            // Ensure fullscreen mode is off when closing the video modal
            toggleFullscreen(videoModalContent, false); // Force fullscreen off on close
        }

        // NEW: Detects if the current device is likely a mobile device.
        function isMobileDevice() {
            // Check for common mobile user agent strings
            const mobileRegex = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
            // Also consider smaller screens as mobile (e.g., less than 768px width)
            const isSmallScreen = window.innerWidth <= 768; 
            return mobileRegex.test(navigator.userAgent) || isSmallScreen;
        }

        // NEW: Opens the dedicated HTML Game Play Modal
        async function openGamePlayModal(gameSrc, deviceCompatibility) {
            if (!gameSrc) {
                showAlert("No game source provided.");
                return;
            }

            const mobile = isMobileDevice();
            let compatibilityMessage = '';

            if (deviceCompatibility === 'Desktop Only' && mobile) {
                compatibilityMessage = "This game is designed for desktop only and may not function correctly on mobile devices.";
            } else if (deviceCompatibility === 'Mobile Only' && !mobile) {
                compatibilityMessage = "This game is designed for mobile devices only and may not function correctly on desktop.";
            }

            if (compatibilityMessage) {
                const proceed = await showConfirm(`${compatibilityMessage}\nDo you still want to try playing?`);
                if (!proceed) {
                    return;
                }
            }

            gameIframePlayer.src = gameSrc;
            gamePlayModal.classList.remove('hidden');
            // Apply fullscreen if setting is enabled
            if (userSettings.modalFullscreen) {
                toggleFullscreen(gamePlayModalContent, true);
            }
        }

        // NEW: Closes the dedicated HTML Game Play Modal
        function closeGamePlayModal() {
            gamePlayModal.classList.add('hidden');
            gameIframePlayer.src = ''; // Stop game playback by clearing src
            toggleFullscreen(gamePlayModalContent, false); // Force fullscreen off on close
        }


        // Function to render genre checkboxes based on a filtered list
        // Moved to global scope for accessibility
        function renderGenreCheckboxes(targetContainer, filterTerm = '') {
            console.log("renderGenreCheckboxes called with filterTerm:", filterTerm);
            const lowerCaseFilterTerm = filterTerm.toLowerCase();
            const filteredGenres = genres.filter(g => g.toLowerCase().includes(lowerCaseFilterTerm));
            console.log("Filtered genres count:", filteredGenres.length);

            targetContainer.innerHTML = filteredGenres
                .map(g => {
                    const isChecked = selectedGenres.includes(g) ? 'checked' : '';
                    const isHighlighted = lowerCaseFilterTerm && g.toLowerCase().includes(lowerCaseFilterTerm) ? 'genre-highlight' : '';
                    return `<label class="custom-checkbox"><input type="checkbox" name="genre" value="${g}" ${isChecked}><span class="${isHighlighted}">${g}</span></label>`;
                }).join('');

            // Update search status message (assuming a status element exists near the genre checkboxes)
            const genreSearchStatus = document.getElementById('genre-search-status'); // This needs to be globally accessible or passed
            if (genreSearchStatus) { // Check if element exists before manipulating
                if (filterTerm) {
                    genreSearchStatus.textContent = `Showing genres matching "${filterTerm}"`;
                    genreSearchStatus.classList.remove('hidden');
                } else {
                    genreSearchStatus.classList.add('hidden');
                }
            }
        }

        // Helper function to format numbers (e.g., 1250 -> 1.3k)
        function formatNumberForDisplay(num) {
            if (num === undefined || num === null) return 0;
            if (userSettings.defaultPostCountDisplay === 'abbreviated' && num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // --- SETTINGS FUNCTIONS ---
        // Applies the current theme, text size, and animation settings to the body.
        function applySettings() {
            const body = document.body;

            // Apply theme
            body.classList.remove('light-mode', 'dark-mode');
            if (userSettings.theme === 'light') {
                body.classList.add('light-mode');
            } else if (userSettings.theme === 'dark') {
                body.classList.add('dark-mode'); // Currently same as default, but good for explicit control
            } else { // System preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                    body.classList.add('light-mode');
                }
            }

            // Apply text size
            body.classList.remove('text-sm', 'text-base', 'text-lg');
            body.classList.add(`text-${userSettings.textSize}`);

            // Apply animations preference
            if (userSettings.animations) {
                body.classList.remove('no-animations');
            } else {
                body.classList.add('no-animations');
            }

            // Re-render current page to apply changes that affect post cards (e.g., count display)
            const activeTab = document.querySelector('.nav-item.active')?.getAttribute('data-tab') || 'community';
            currentSortBy = 'newest'; // Default sort order is always newest now.

            if (activeTab === 'community') {
                renderCommunityPage();
            } else if (activeTab === 'my-posts') {
                renderMyPostsPage();
            } else if (activeTab === 'html-games') { // Changed from promos
                renderHtmlGamesPage(); // Changed from promos
            } else if (activeTab === 'devlogs') {
                renderDevlogsPage();
            } else if (activeTab === 'search') {
                handleSearch(); // Re-run search to apply changes
            }
        }

        // Saves user settings to Local Storage.
        function saveUserSettings() {
            try {
                localStorage.setItem('userSettings', JSON.stringify(userSettings));
                console.log("User settings saved to local storage:", userSettings);
            } catch (error) {
                console.error("Error saving user settings to local storage:", error);
            }
        }

        // Loads user settings from Local Storage.
        function loadUserSettings() {
            try {
                const storedSettings = localStorage.getItem('userSettings');
                if (storedSettings) {
                    userSettings = { ...userSettings, ...JSON.parse(storedSettings) };
                    console.log("User settings loaded from local storage:", userSettings);
                } else {
                    console.log("No user settings found in local storage, using defaults.");
                }
                applySettings(); // Apply loaded or default settings immediately
            } catch (error) {
                console.error("Error loading user settings from local storage:", error);
            }
        }


        // --- EVENT LISTENERS SETUP ---
        // Attaches event listeners to dynamically created post cards.
        function addCardEventListeners(isMyPostPage = false) {
            document.querySelectorAll('.card-bg[data-id]').forEach(card => {
                // Event listener for opening the modal (excluding clicks on media or buttons)
                card.addEventListener('click', async (e) => {
                    // Check if the click target is the media placeholder or a button
                    if (e.target.closest('.media-placeholder') || e.target.closest('.youtube-link-btn') || e.target.closest('button')) {
                        return; // Do nothing if media placeholder, YouTube link button, or other button was clicked
                    }
                    const postId = card.dataset.id;
                    // Only open the post modal if it's not already open
                    if (!isPostModalOpen) {
                        await openPostModal(postId, false, true); // Explicitly increment view for user-initiated open
                    }
                });
            });

            // Event listener for playing YouTube videos from thumbnail (for 'youtube' media type)
            document.querySelectorAll('.media-placeholder[data-video-id]').forEach(placeholder => {
                placeholder.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click event from firing
                    const videoId = placeholder.dataset.videoId;
                    loadYouTubeVideo(placeholder, videoId);
                });
            });
            
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); toggleLike(btn.dataset.id); });
            });

            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); openPostModal(btn.dataset.id, true, false); }); // Don't increment view when opening from comment button
            });

            // Only add delete/edit listeners if on My Posts page
            if (isMyPostPage) {
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const confirmed = await showConfirm("Are you sure you want to delete this post? This action cannot be undone.");
                        if (confirmed) {
                            try {
                                // Correct Firestore path for deletion, using the dynamic appId
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/posts`, btn.dataset.id));
                                showAlert("Post deleted successfully.");
                                // The real-time listener will automatically update the UI.
                            } catch (err) {
                                console.error("Error deleting post:", err);
                                showAlert(`Could not delete post: ${err.message || err}.`);
                            }
                        }
                    });
                });
                // Add event listener for edit buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditModal(btn.dataset.id);
                    });
                });
            }
        }

        // --- AUTHENTICATION & APP STARTUP ---
        // Listens for Firebase authentication state changes.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
            } else {
                // If no user is logged in, attempt to sign in anonymously.
                try {
                    await signInAnonymously(auth);
                    currentUser = auth.currentUser; // Update currentUser after successful sign-in
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showAlert(`Authentication failed: ${error.message}. Some features may not work.`);
                }
            }
            // Initialize app state only once after authentication is confirmed ready.
            if (!isAuthReady) {
                isAuthReady = true;
                initializeAppState();
            }
        });

        // Initializes the main application state after authentication.
		function initializeAppState() {
			console.log("HTMLIT App Initializing...");
			console.log("Using Firebase Project ID (as App ID):", appId);
			console.log("Firestore Collection Path for posts:", `artifacts/${appId}/public/data/posts`);
            loadUserSettings(); // Load settings immediately on app start
			loader.style.display = 'none'; // Hide the loading spinner
			listenForPostsRealtime(); // Start real-time listening for ALL posts
			setupNavListeners(); // Set up navigation event handlers

			// Check for postId in URL and open modal if present
			const urlParams = new URLSearchParams(window.location.search);
			const postIdFromUrl = urlParams.get('postId');
			const sectionFromUrl = urlParams.get('section');

			if (postIdFromUrl) {
				// Wait for posts to be fetched before attempting to open the modal
				const checkPostsInterval = setInterval(() => {
					if (allFetchedPosts.length > 0) {
						clearInterval(checkPostsInterval);
						openPostModal(postIdFromUrl, false, true); // Increment view if opened via URL
					}
				}, 100); // Check every 100ms
			} else if (sectionFromUrl) {
				switchTab(sectionFromUrl);
			} else {
				switchTab('community'); // Load the default community feed tab if no postId or section in URL
			}
			// Add event listener for the new video modal close button
			closeVideoModalBtn.addEventListener('click', closeVideoModal);
            // Add event listener for the new video modal fullscreen toggle button
            fullscreenVideoToggleBtn.addEventListener('click', () => toggleFullscreen(videoModalContent));

            // NEW: Add event listeners for the game play modal
            closeGamePlayModalBtn.addEventListener('click', closeGamePlayModal);
            fullscreenGameIframeToggleBtn.addEventListener('click', () => toggleGameFullscreen(gameIframePlayer));
        }
        
        // Sets up event listeners for navigation buttons (desktop and mobile).
        function setupNavListeners() {
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = e.target.getAttribute('data-tab');
                    if (tab) {
                        // Update URL with section parameter
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set('section', tab);
                        newUrl.searchParams.delete('postId'); // Remove postId if navigating to a section
                        window.history.pushState({}, '', newUrl.toString());
                        switchTab(tab);
                        mobileMenu.classList.add('hidden'); // Hide mobile menu on tab selection
                    }
                });
            });
        }

        // --- NAVIGATION LOGIC ---
        // Switches the active tab and renders its content.
        function switchTab(tab) {
            // Update active navigation item styling
            navItems.forEach(item => {
                item.classList.toggle('active', item.getAttribute('data-tab') === tab);
            });
            // Show/hide corresponding tab content sections
            tabContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== `content-${tab}`);
            });
            
            // Map tab names to their respective rendering functions
            const renderMap = {
                community: renderCommunityPage,
                'html-games': renderHtmlGamesPage, // Changed from promos
                devlogs: renderDevlogsPage,
                post: () => renderPostPage(contentPost), // Pass contentPost as target
                search: renderSearchPage,
                'my-posts': renderMyPostsPage,
                about: renderAboutPage,
                rules: renderRulesPage,
                settings: renderSettingsPage,
            };
            renderMap[tab]?.(); // Call the appropriate rendering function
        }
        
        // Renders a single post card for display in community/search/my posts grids.
        function renderPostCard(post, isMyPostPage = false) {
            const isAuthor = post.authorId === currentUser?.uid;
            let mediaHtml = '';
            const cardTypeClass = post.postType === 'Devlog' ? 'card-devlog' : 'card-html-game'; // Changed class

            // Conditional rendering of media based on `mediaType` field
            if (post.mediaType === 'youtube' && post.trailerLink) {
                const videoId = getYouTubeVideoId(post.trailerLink);
                if (videoId) {
                    const thumbnailUrl = getYouTubeThumbnailUrl(videoId);
                    mediaHtml = `
                        <div class="media-placeholder w-full h-full relative cursor-pointer" data-video-id="${videoId}">
                            <img src="${thumbnailUrl}" alt="YouTube Thumbnail" class="w-full h-full object-cover rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/600x400/101010/808080?text=Video+Not+Found';">
                            <div class="play-button-overlay">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                    `;
                }
            } else if (post.mediaType === 'image' && post.imageUrl) {
                 mediaHtml = `<img src="${post.imageUrl}" alt="${post.title}" class="w-full h-full object-cover rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/600x400/101010/808080?text=Image+Not+Found';">`;
            } else if (post.mediaType === 'combo' && post.trailerLink && post.imageUrl) {
                // For combo, display only the image on the preview card
                mediaHtml = `<img src="${post.imageUrl}" alt="Custom Thumbnail" class="w-full h-full object-cover rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/600x400/101010/808080?text=Custom+Thumbnail+Not+Found';">`;
            } else if (post.mediaType === 'html_embed') { // New HTML embed type
                mediaHtml = `<div class="h-full bg-[#101010] flex flex-col items-center justify-center text-gray-500 rounded-t-lg p-4">
                                <i class="fas fa-code fa-3x mb-2"></i>
                                <p class="text-center">HTML Game</p>
                                <p class="text-xs text-gray-600 mt-1">Click to Play</p>
                            </div>`;
            }
            // Fallback content if no valid media is provided or selected (or mediaType is 'none')
            if (!mediaHtml || post.mediaType === 'none') {
                mediaHtml = `<div class="h-full bg-[#101010] flex items-center justify-center text-gray-500 rounded-t-lg"><i class="fas fa-image fa-3x"></i></div>`;
            }

            return `
                <div class="card-bg rounded-lg overflow-hidden flex flex-col cursor-pointer ${cardTypeClass}" data-id="${post.id}">
                    <div class="thumbnail-container">
                        ${mediaHtml}
                    </div>
                    
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-xl font-bold mb-2 truncate text-white">${post.title}</h3>
                        <p class="text-gray-400 text-sm mb-4 flex-grow">${post.description.substring(0, 100)}${post.description.length > 100 ? '...' : ''}</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${post.genres && post.genres.slice(0, 3).map(g => `<span class="bg-gray-700 text-xs font-semibold px-2 py-1 rounded-full text-gray-200">${g}</span>`).join('')}
                            ${post.tags && post.tags.slice(0, 3).map(t => `<span class="bg-purple-700 text-xs font-semibold px-2 py-1 rounded-full text-gray-200">${t}</span>`).join('')}
                        </div>
                        ${userSettings.showPostCounts ? `
                            <div class="flex justify-between items-center mt-auto pt-2 border-t border-gray-700">
                                <div class="flex space-x-4 text-gray-400">
                                    <button class="like-btn hover:text-white transition" data-id="${post.id}">
                                        <i class="${post.likes?.includes(currentUser?.uid) ? 'fas text-red-500' : 'far'} fa-heart"></i>
                                        <span class="ml-1">${formatNumberForDisplay(post.likes?.length || 0)}</span>
                                    </button>
                                    <button class="comment-btn hover:text-white transition" data-id="${post.id}">
                                        <i class="fas fa-comment"></i>
                                        <span class="ml-1">${formatNumberForDisplay(post.comments?.length || 0)}</span>
                                    </button>
                                    <span class="inline-flex items-center">
                                        <button class="hover:text-white transition cursor-default">
                                            <i class="fas fa-eye mr-1"></i>
                                            <span class="ml-1">${formatNumberForDisplay(post.views || 0)}</span>
                                        </button>
                                    </span>
                                    ${post.postType === 'HTML Game' ? `
                                        <span class="inline-flex items-center">
                                            <button class="hover:text-white transition cursor-default">
                                                <i class="fas fa-gamepad mr-1"></i> <!-- Changed to gamepad icon -->
                                                <span class="ml-1">${formatNumberForDisplay(post.visits || 0)}</span>
                                            </button>
                                        </span>
                                    ` : ''}
                                </div>
                                ${isMyPostPage && isAuthor ? `
                                    <div class="flex space-x-2">
                                        <button class="edit-btn text-blue-500 hover:text-blue-400 transition" data-id="${post.id}"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-400 transition" data-id="${post.id}"><i class="fas fa-trash"></i></button>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            ${isMyPostPage && isAuthor ? `
                                <div class="flex justify-end mt-auto pt-2 border-t border-gray-700">
                                    <div class="flex space-x-2">
                                        <button class="edit-btn text-blue-500 hover:text-blue-400 transition" data-id="${post.id}"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn text-red-500 hover:text-red-400 transition" data-id="${post.id}"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            ` : ''}
                        `}
                    </div>
                </div>
            `;
        }
        
        // Helper function to render a grid of posts with filtering and sorting
        function renderPostsGrid(targetElement, posts, pageTitle, includeAiContentFilter = true, includeSortBy = true, isMyPostPage = false) { // Removed includePricingFilter
            let filteredPosts = posts;

            // Removed pricing filter logic
            
            if (includeAiContentFilter) {
                filteredPosts = filteredPosts.filter(post => {
                    if (currentAiContentFilter === 'all') return true;
                    return post.aiContent === currentAiContentFilter;
                });
            }

            let sortedPosts = [...filteredPosts];
            if (includeSortBy) {
                if (currentSortBy === 'popular') sortedPosts.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0));
                else if (currentSortBy === 'newest') sortedPosts.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                else if (currentSortBy === 'oldest') sortedPosts.sort((a, b) => a.createdAt.toDate() - a.createdAt.toDate());
                else if (currentSortBy === 'most-viewed') sortedPosts.sort((a, b) => (b.views || 0) - (a.views || 0));
                else if (currentSortBy === 'most-visited') sortedPosts.sort((a, b) => (b.visits || 0) - (a.visits || 0));
            }

            const postsToDisplay = sortedPosts.slice(0, displayLimit);

            targetElement.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-white">${pageTitle}</h2>
                    <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                        ${includeAiContentFilter ? `
                            <div class="custom-select w-full sm:w-auto">
                                <select id="ai-content-filter" class="input-bg rounded-md p-2 pl-4 pr-8 w-full">
                                    <option value="all" ${currentAiContentFilter === 'all' ? 'selected' : ''}>AI Content (All)</option>
                                    <option value="Yes" ${currentAiContentFilter === 'Yes' ? 'selected' : ''}>No (AI Content)</option>
                                    <option value="No" ${currentAiContentFilter === 'No' ? 'selected' : ''}>Yes (No AI Content)</option>
                                </select>
                            </div>
                        ` : ''}
                        ${includeSortBy ? `
                            <div class="custom-select w-full sm:w-auto">
                                <select id="sort-by" class="input-bg rounded-md p-2 pl-4 pr-8 w-full">
                                    <option value="newest" ${currentSortBy === 'newest' ? 'selected' : ''}>Newest</option>
                                    <option value="popular" ${currentSortBy === 'popular' ? 'selected' : ''}>Most Popular</option>
                                    <option value="oldest" ${currentSortBy === 'oldest' ? 'selected' : ''}>Oldest</option>
                                    <option value="most-viewed" ${currentSortBy === 'most-viewed' ? 'selected' : ''}>Most Viewed</option>
                                    <option value="most-visited" ${currentSortBy === 'most-visited' ? 'selected' : ''}>Most Played</option> <!-- Changed text -->
                                </select>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${postsToDisplay.length > 0 ? postsToDisplay.map(post => renderPostCard(post, isMyPostPage)).join('') : '<p class="col-span-full text-center text-gray-400">No posts yet. Be the first to share your game!</p>'}
                </div>
                <div id="load-more-container" class="flex justify-center mt-8">
                    ${displayLimit < filteredPosts.length ? `<button id="load-more-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">Load More <i class="fas fa-arrow-down"></i></button>` : `<p class="text-gray-400">All posts loaded!</p>`}
                </div>
            `;

            if (includeSortBy) {
                const sortBySelect = targetElement.querySelector('#sort-by');
                if (sortBySelect) {
                    sortBySelect.addEventListener('change', (e) => {
                        currentSortBy = e.target.value;
                        displayLimit = postsPerPage; // Reset limit on sort change
                        renderPostsGrid(targetElement, posts, pageTitle, includeAiContentFilter, includeSortBy, isMyPostPage); // Removed pricing filter
                    });
                }
            }
            // Removed pricing filter event listener
            if (includeAiContentFilter) {
                const aiContentFilterSelect = targetElement.querySelector('#ai-content-filter');
                if (aiContentFilterSelect) {
                    aiContentFilterSelect.addEventListener('change', (e) => {
                        currentAiContentFilter = e.target.value;
                        displayLimit = postsPerPage; // Reset limit on filter change
                        renderPostsGrid(targetElement, posts, pageTitle, includeAiContentFilter, includeSortBy, isMyPostPage); // Removed pricing filter
                    });
                }
            }

            addCardEventListeners(isMyPostPage);

            const loadMoreBtn = targetElement.querySelector('#load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', () => {
                    // Add loading animation
                    loadMoreBtn.disabled = true;
                    loadMoreBtn.innerHTML = `<span class="spinner"></span> Loading...`;
                    loadMoreBtn.classList.add('animate-pulse'); // Add Tailwind pulse animation

                    displayLimit += postsPerPage;
                    renderPostsGrid(targetElement, posts, pageTitle, includeAiContentFilter, includeSortBy, isMyPostPage); // Removed pricing filter
                    // The button will be re-rendered by renderPostsGrid, effectively resetting its state.
                });
            }
        }


        // Renders the main community feed page.
        function renderCommunityPage() {
            const communityPosts = allFetchedPosts.filter(p => p.postType === 'HTML Game' || p.postType === 'Devlog'); // Changed from Game Promotion
            renderPostsGrid(contentCommunity, communityPosts, "Community Feed", true, true, false); // Removed pricing filter
        }

        // Renders the HTML Games page.
        function renderHtmlGamesPage() { // Changed from renderPromosPage
            const htmlGamePosts = allFetchedPosts.filter(p => p.postType === 'HTML Game'); // Changed filter
            renderPostsGrid(contentHtmlGames, htmlGamePosts, "HTML Games", true, true, false); // Changed title, removed pricing filter
        }

        // Renders the Devlogs page.
        function renderDevlogsPage() {
            const devlogPosts = allFetchedPosts.filter(p => p.postType === 'Devlog');
            renderPostsGrid(contentDevlogs, devlogPosts, "Devlogs", true, true, false); // Removed pricing filter
        }
        
        // Renders the form for creating a new post.
        function renderPostPage(targetElement) {
            // Removed platforms array as it's no longer needed for HTML Games
            const devlogTypes = ["Update", "Q&A", "Announcement", "Behind the Scenes", "Concept Art", "Development Progress", "Game Jam Entry", "Post-Mortem", "Release Info", "Tutorial", "Bug Fixes", "Roadmap", "Community Spotlight", "Poll", "Patch Notes", "Lore Deep Dive", "Music Showcase", "Art Showcase", "Level Design", "Character Design", "Story Development", "Technical Deep Dive", "Monetization", "Marketing", "Legal", "Other"];

            // Filter for only HTML Game posts by the current user to link in Devlogs
            const myHtmlGamePosts = currentUser?.uid ? allFetchedPosts.filter(p => p.postType === 'HTML Game' && p.authorId === currentUser.uid) : [];


            targetElement.innerHTML = `
                <div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-white">${editingPostId ? 'Edit Your Post' : 'Share Your HTML Game or Devlog'}</h2>
                    <form id="post-form" class="space-y-6">
                        <div>
                            <label for="post-type" class="block mb-2 font-semibold text-gray-300">What are you posting?</label>
                            <div class="custom-select">
                                <select id="post-type" class="w-full p-3 input-bg rounded-md" required ${editingPostId ? 'disabled' : ''}>
                                    <option value="HTML Game" ${userSettings.defaultPostType === 'HTML Game' ? 'selected' : ''}>HTML Game</option>
                                    <option value="Devlog" ${userSettings.defaultPostType === 'Devlog' ? 'selected' : ''}>Devlog</option>
                                </select>
                            </div>
                        </div>

                        <div id="devlog-type-section" class="hidden">
                            <label for="devlog-type" class="block mb-2 font-semibold text-gray-300">Devlog Type</label>
                            <div class="custom-select">
                                <select id="devlog-type" class="w-full p-3 input-bg rounded-md">
                                    ${devlogTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div id="html-game-poll-toggle" class="hidden">
                            <label class="block mb-2 font-semibold text-gray-300">Add Poll?</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="add-html-game-poll" value="true">
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="add-html-game-poll" value="false" checked>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div id="poll-section" class="hidden border-t border-gray-700 pt-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-400">Poll Details</h3>
                            <p class="text-sm text-red-600 mb-4">
                                Important: Polls cannot be deleted or modified after the post is first submitted.
                            </p>
                            <div>
                                <label for="poll-question" class="block mb-2 font-semibold text-gray-300">Poll Question</label>
                                <input type="text" id="poll-question" class="w-full p-3 input-bg rounded-md" placeholder="e.g., What feature should we add next?">
                            </div>
                            <div id="poll-options-container" class="mt-4 space-y-2">
                                <label class="block mb-2 font-semibold text-gray-300">Poll Options (Min 2, Max 5)</label>
                                <div class="flex gap-2">
                                    <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option 1" required>
                                    <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md hidden"><i class="fas fa-minus"></i></button>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option 2" required>
                                    <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md hidden"><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <button type="button" id="add-poll-option-btn" class="btn-primary text-white font-bold py-2 px-4 rounded-md mt-4"><i class="fas fa-plus mr-2"></i>Add Option</button>
                        </div>


                        <div>
                            <label for="game-title" class="block mb-2 font-semibold text-gray-300">Title</label>
                            <input type="text" id="game-title" class="w-full p-3 input-bg rounded-md" required>
                        </div>
                        <div>
                            <label for="description" class="block mb-2 font-semibold text-gray-300">Description (100-1000 chars)</label>
                            <textarea id="description" rows="5" class="w-full p-3 input-bg rounded-md" minlength="100" maxlength="1000" required></textarea>
                            <p id="char-count" class="text-sm text-gray-400 mt-1 text-right">0/1000</p>
                        </div>
                        
                        <!-- HTML Game URL/Code Section -->
                        <div id="html-game-link-code-section">
                            <label for="html-game-url" class="block mb-2 font-semibold text-gray-300" id="html-game-url-label">
                                HTML Game URL (Optional)
                                <span class="text-xs text-gray-500 ml-2 html-game-url-help">
                                    (Link to your hosted HTML game. e.g., https://yourdomain.com/your-game/index.html)
                                </span>
                            </label>
                            <input type="url" id="html-game-url" class="w-full p-3 input-bg rounded-md" placeholder="e.g., https://example.com/my-game/index.html">
                            
                            <div class="mt-4">
                                <label for="html-game-code" class="block mb-2 font-semibold text-gray-300">
                                    HTML Game Code (Optional)
                                    <span class="text-xs text-gray-500 ml-2">
                                        (Paste your full HTML code here. Max 1MB. If both URL and code are provided, URL will be used.)
                                    </span>
                                </label>
                                <textarea id="html-game-code" rows="10" class="w-full p-3 input-bg rounded-md font-mono text-sm" placeholder="Your HTML game code here"></textarea>
                                <button type="button" id="preview-html-game-btn" class="btn-primary text-white font-bold py-2 px-4 rounded-md mt-2"><i class="fas fa-play-circle mr-2"></i>Preview HTML Game</button>
                                <div id="html-game-preview-container" class="mt-4 hidden">
                                    <p class="text-gray-400 text-sm mb-2">Live Preview:</p>
                                    <div class="html-game-preview-aspect-ratio">
                                        <iframe id="html-game-preview-iframe" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-pointer-lock allow-downloads"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End HTML Game URL/Code Section -->
                        
                        <!-- NEW: Device Compatibility Section -->
                        <div id="device-compatibility-section">
                            <label class="block mb-2 font-semibold text-gray-300">Device Compatibility</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="device-compatibility" value="Desktop Only" checked>
                                    <span>Desktop Only</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="device-compatibility" value="Mobile Only">
                                    <span>Mobile Only</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="device-compatibility" value="Both">
                                    <span>Both (Desktop & Mobile)</span>
                                </label>
                            </div>
                        </div>
                        <!-- End Device Compatibility Section -->

                        <!-- Media Selection Section -->
                        <div class="mb-4">
                            <label class="block mb-2 font-semibold text-gray-300">Choose Media for Display</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="youtube" id="media-youtube" checked>
                                    <span>YouTube Trailer</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="image" id="media-image">
                                    <span>Image Link</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="combo" id="media-combo">
                                    <span>Combo</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="html_embed" id="media-html-embed">
                                    <span>HTML Preview</span> <!-- New option -->
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="media-type" value="none" id="media-none">
                                    <span>None</span>
                                </label>
                            </div>
                        </div>

                        <div id="youtube-link-section">
                            <label for="trailer-link" class="block mb-2 font-semibold text-gray-300" id="trailer-link-label">
                                YouTube Link (Optional)
                                <span class="text-xs text-gray-500 ml-2 youtube-link-help">
                                    (e.g., from YouTube, click Share -> Copy Link. Example: https://youtu.be/dQw4w9WgXcQ)
                                </span>
                            </label>
                            <input type="url" id="trailer-link" class="w-full p-3 input-bg rounded-md" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                        </div>

                        <div id="image-link-section" class="hidden">
                            <label for="image-url" class="block mb-2 font-semibold text-gray-300" id="image-url-label">
                                Image URL (Optional)
                                <span class="text-xs text-gray-500 ml-2 image-link-help">
                                    (e.g., Right-click image -> Copy Image Address. Example: https://placehold.co/600x400/101010/808080?text=Image)
                                </span>
                            </label>
                            <input type="url" id="image-url" class="w-full p-3 input-bg rounded-md" placeholder="e.g., https://example.com/your-game-screenshot.png">
                        </div>

                        <div id="custom-youtube-text-section" class="hidden">
                            <label for="custom-youtube-link-text" class="block mb-2 font-semibold text-gray-300">
                                Custom YouTube Link Text (e.g., "Watch Gameplay", "View Trailer")
                            </label>
                            <input type="text" id="custom-youtube-link-text" class="w-full p-3 input-bg rounded-md" placeholder="e.g., Watch Trailer">
                        </div>
                        <!-- End Media Selection Section -->

                        <div id="linked-game-promo-section" class="hidden">
                            <label for="linked-game-promo" class="block mb-2 font-semibold text-gray-300">Link to one of your HTML Games (Required for Devlogs)</label>
                            <div class="custom-select">
                                <select id="linked-game-promo" class="w-full p-3 input-bg rounded-md">
                                    <option value="">Select one of your HTML Games</option>
                                    ${myHtmlGamePosts.map(game => `<option value="${game.id}">${game.title}</option>`).join('')}
                                </select>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">If selected, clicking this Devlog will open the linked HTML Game card.</p>
                        </div>

                        <div>
                            <label for="tags" class="block mb-2 font-semibold text-gray-300">
                                Tags (Optional, comma-separated)
                                <span class="text-xs text-gray-500 ml-2">
                                    (e.g., action, indie, pixel art)
                                </span>
                            </label>
                            <input type="text" id="tags" class="w-full p-3 input-bg rounded-md" placeholder="e.g., adventure, puzzle, 2d">
                        </div>

                        <div id="genre-section">
                            <label class="block mb-2 font-semibold text-gray-300">Genre (select at least 3 for HTML Game)</label>
                            <input type="text" id="genre-search" class="w-full p-3 input-bg rounded-md mb-3" placeholder="Search genres...">
                            <p id="genre-search-status" class="text-sm text-gray-400 mb-3 hidden"></p>
                            <div id="genre-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3 grid-checkbox-uniform">
                                <!-- Genres will be dynamically inserted here -->
                            </div>
                        </div>
                        <!-- Removed Platform Section -->
                        <div id="comments-status-section">
                            <label class="block mb-2 font-semibold text-gray-300">Allow Comments?</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="allow-comments" value="true" checked required>
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="allow-comments" value="false" required>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label for="made-with" class="block mb-2 font-semibold text-gray-300">Technologies Used (Optional)</label> <!-- Renamed label -->
                            <input type="text" id="made-with" class="w-full p-3 input-bg rounded-md" placeholder="e.g., JavaScript, Phaser, WebGL, HTML5"> <!-- Updated placeholder -->
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Does this game contain AI generated content?</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="ai-content" value="Yes" required>
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="ai-content" value="No" required>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label for="general" class="block mb-2 font-semibold text-gray-300">General Info (Optional)</label>
                            <textarea id="general" rows="3" class="w-full p-3 input-bg rounded-md"></textarea>
                        </div>
                        <div>
                            <label for="reason" class="block mb-2 font-semibold text-gray-300">Why are you posting here? (Optional)</label>
                            <textarea id="reason" rows="3" class="w-full p-3 input-bg rounded-md"></textarea>
                        </div>
                        <button type="submit" id="submit-post-btn" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-md text-lg">${editingPostId ? 'Update Post' : 'Submit Post'}</button>
                    </form>
                </div>
            `;
            // Event listeners are attached to the form and its elements within the targetElement
            const form = targetElement.querySelector('#post-form');
            if (form) {
                form.addEventListener('submit', handlePostSubmit);
                form.querySelector('#description').addEventListener('input', e => {
                    form.querySelector('#char-count').textContent = `${e.target.value.length}/1000`;
                });

                const mediaTypeRadios = form.querySelectorAll('input[name="media-type"]');
                const youtubeLinkSection = form.querySelector('#youtube-link-section');
                const imageLinkSection = form.querySelector('#image-link-section');
                const customYoutubeLinkSection = form.querySelector('#custom-youtube-text-section');
                const youtubeLinkHelp = form.querySelector('.youtube-link-help');
                const imageLinkHelp = form.querySelector('.image-link-help');
                const htmlGameUrlInput = form.querySelector('#html-game-url'); // Changed from itch-link
                const htmlGameCodeInput = form.querySelector('#html-game-code'); // New
                const htmlGameLinkCodeSection = form.querySelector('#html-game-link-code-section'); // New
                const htmlGameUrlLabel = form.querySelector('#html-game-url-label'); // New
                const htmlGameUrlHelp = form.querySelector('.html-game-url-help'); // New

                const previewHtmlGameBtn = form.querySelector('#preview-html-game-btn'); // New
                const htmlGamePreviewContainer = form.querySelector('#html-game-preview-container'); // New
                const htmlGamePreviewIframe = form.querySelector('#html-game-preview-iframe'); // New

                const postTypeSelect = form.querySelector('#post-type');
                const devlogTypeSelect = form.querySelector('#devlog-type');
                const devlogTypeSection = form.querySelector('#devlog-type-section');
                const htmlGamePollToggle = form.querySelector('#html-game-poll-toggle'); // Changed
                const addHtmlGamePollRadios = form.querySelectorAll('input[name="add-html-game-poll"]'); // Changed
                const pollSection = form.querySelector('#poll-section');
                const genreSection = form.querySelector('#genre-section');
                const deviceCompatibilitySection = form.querySelector('#device-compatibility-section'); // NEW
                // Removed platformSection
                // Removed pricingSection
                const commentsStatusSection = form.querySelector('#comments-status-section');
                const linkedGamePromoSection = form.querySelector('#linked-game-promo-section');
                const genreSearchInput = form.querySelector('#genre-search');
                const genreCheckboxesContainer = form.querySelector('#genre-checkboxes');

                // HTML Game Preview Logic
                if (previewHtmlGameBtn) {
                    previewHtmlGameBtn.addEventListener('click', () => {
                        const htmlCode = htmlGameCodeInput.value.trim();
                        if (htmlCode) {
                            htmlGamePreviewContainer.classList.remove('hidden');
                            // Create a Blob URL for the HTML content
                            const blob = new Blob([htmlCode], { type: 'text/html' });
                            const blobUrl = URL.createObjectURL(blob);
                            htmlGamePreviewIframe.src = blobUrl;
                            htmlGamePreviewIframe.onload = () => {
                                // Revoke the Blob URL once the content is loaded to free up memory
                                URL.revokeObjectURL(blobUrl);
                            };
                        } else {
                            htmlGamePreviewContainer.classList.add('hidden');
                            htmlGamePreviewIframe.src = 'about:blank'; // Clear iframe
                            showAlert("Please enter HTML code to preview.");
                        }
                    });
                }

                // Initial render of all genres
                renderGenreCheckboxes(genreCheckboxesContainer, genreSearchInput.value);

                // Event delegation for genre checkboxes to update selectedGenres array
                genreCheckboxesContainer.addEventListener('change', (e) => {
                    if (e.target.name === 'genre') {
                        if (e.target.checked) {
                            if (!selectedGenres.includes(e.target.value)) {
                                selectedGenres.push(e.target.value);
                            }
                        } else {
                            selectedGenres = selectedGenres.filter(g => g !== e.target.value);
                        }
                    }
                });

                // Poll option management
                const pollOptionsContainer = form.querySelector('#poll-options-container');
                const addPollOptionBtn = form.querySelector('#add-poll-option-btn');

                function updateRemovePollOptionButtons() {
                    const removeButtons = pollOptionsContainer.querySelectorAll('.remove-poll-option-btn');
                    if (removeButtons.length <= 2) {
                        removeButtons.forEach(btn => btn.classList.add('hidden'));
                    } else {
                        removeButtons.forEach(btn => btn.classList.remove('hidden'));
                    }
                    if (removeButtons.length >= 5) {
                        addPollOptionBtn.disabled = true;
                        addPollOptionBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        addPollOptionBtn.disabled = false;
                        addPollOptionBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                addPollOptionBtn.addEventListener('click', () => {
                    const currentOptions = pollOptionsContainer.querySelectorAll('.poll-option-input').length;
                    if (currentOptions < 5) {
                        const newOptionDiv = document.createElement('div');
                        newOptionDiv.className = 'flex gap-2';
                        newOptionDiv.innerHTML = `
                            <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option ${currentOptions + 1}" required>
                            <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md"><i class="fas fa-minus"></i></button>
                        `;
                        pollOptionsContainer.appendChild(newOptionDiv);
                        updateRemovePollOptionButtons();
                    }
                });

                pollOptionsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-poll-option-btn') || e.target.closest('.remove-poll-option-btn')) {
                        const btn = e.target.closest('.remove-poll-option-btn');
                        btn.parentElement.remove();
                        updateRemovePollOptionButtons();
                    }
                });

                function toggleMediaSectionsInternal() {
                    const selectedMedia = form.querySelector('input[name="media-type"]:checked')?.value;
                    console.log("toggleMediaSectionsInternal called. Selected Media:", selectedMedia);

                    // Get references to inputs
                    const trailerLinkInput = form.querySelector('#trailer-link');
                    const imageUrlInput = form.querySelector('#image-url');
                    const customYoutubeLinkTextInput = form.querySelector('#custom-youtube-link-text');
                    const htmlGameUrlInput = form.querySelector('#html-game-url'); // Still present for HTML Game post type
                    const htmlGameCodeInput = form.querySelector('#html-game-code'); // Still present for HTML Game post type

                    // Reset visibility for all media sections first
                    if (youtubeLinkSection) youtubeLinkSection.classList.add('hidden');
                    if (imageLinkSection) imageLinkSection.classList.add('hidden');
                    if (customYoutubeLinkSection) customYoutubeLinkSection.classList.add('hidden');
                    // htmlGameLinkCodeSection visibility is handled by post type, not media type

                    // Reset required attributes for all media inputs first
                    trailerLinkInput.removeAttribute('required');
                    imageUrlInput.removeAttribute('required');
                    customYoutubeLinkTextInput.removeAttribute('required');
                    // htmlGameUrlInput and htmlGameCodeInput required status is handled by post type logic

                    if (selectedMedia === 'combo') {
                        if (youtubeLinkSection) youtubeLinkSection.classList.remove('hidden');
                        if (imageLinkSection) imageLinkSection.classList.remove('hidden');
                        if (customYoutubeLinkSection) customYoutubeLinkSection.classList.remove('hidden');
                        
                        if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Required for Combo. Example: https://youtu.be/dQw4w9WgXcQ)';
                        if (imageLinkHelp) imageLinkHelp.textContent = '(Required for Combo. Example: https://example.com/your-game-screenshot.png)';
                        trailerLinkInput.setAttribute('required', 'true');
                        imageUrlInput.setAttribute('required', 'true');
                        customYoutubeLinkTextInput.setAttribute('required', 'true');
                    } else if (selectedMedia === 'youtube') {
                        if (youtubeLinkSection) youtubeLinkSection.classList.remove('hidden');
                        if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Optional. Example: https://youtu.be/dQw4w9WgXcQ)';
                        trailerLinkInput.setAttribute('required', 'true');
                    } else if (selectedMedia === 'image') {
                        if (imageLinkSection) imageLinkSection.classList.remove('hidden');
                        if (imageLinkHelp) imageLinkHelp.textContent = '(Optional. Example: https://example.com/your-game-screenshot.png)';
                        imageUrlInput.setAttribute('required', 'true');
                    } else if (selectedMedia === 'html_embed') { // New HTML embed
                        // No specific required fields for HTML embed media type, as the game itself is the primary content.
                        // The game URL/Code fields are handled by the HTML Game post type logic.
                    } else { // 'none'
                        if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Optional. Example: https://youtu.be/dQw4w9WgXcQ)';
                        if (imageLinkHelp) imageLinkHelp.textContent = '(Optional. Example: https://example.com/your-game-screenshot.png)';
                    }
                }
                mediaTypeRadios.forEach(radio => radio.addEventListener('change', toggleMediaSectionsInternal));

                function togglePostTypeFieldsInternal() {
                    const selectedPostType = postTypeSelect.value;
                    const selectedDevlogType = devlogTypeSelect?.value;
                    const addHtmlGamePoll = form.querySelector('input[name="add-html-game-poll"]:checked')?.value === 'true';

                    // Reset all devlog specific fields to hidden and optional
                    if (devlogTypeSection) devlogTypeSection.classList.add('hidden');
                    if (htmlGamePollToggle) htmlGamePollToggle.classList.add('hidden');
                    if (pollSection) pollSection.classList.add('hidden');
                    form.querySelector('#poll-question')?.removeAttribute('required');
                    form.querySelectorAll('.poll-option-input').forEach(input => input.removeAttribute('required'));
                    if (deviceCompatibilitySection) deviceCompatibilitySection.classList.add('hidden'); // NEW

                    console.log("togglePostTypeFieldsInternal: selectedPostType =", selectedPostType, "selectedDevlogType =", selectedDevlogType, "addHtmlGamePoll =", addHtmlGamePoll);

                    if (selectedPostType === 'Devlog') {
                        if (devlogTypeSection) devlogTypeSection.classList.remove('hidden');
                        if (genreSection) genreSection.classList.add('hidden');
                        // Removed platformSection.classList.add('hidden');
                        // Removed pricingSection.classList.add('hidden');
                        if (commentsStatusSection) commentsStatusSection.classList.add('hidden');
                        if (linkedGamePromoSection) linkedGamePromoSection.classList.remove('hidden');
                        if (deviceCompatibilitySection) deviceCompatibilitySection.classList.add('hidden'); // NEW

                        if (htmlGameUrlInput) {
                            htmlGameUrlInput.removeAttribute('required');
                        }
                        if (htmlGameUrlLabel) htmlGameUrlLabel.textContent = 'HTML Game URL (Optional)';
                        if (htmlGameUrlHelp) htmlGameUrlHelp.textContent = '(Link to your hosted HTML game. Optional for Devlog.)';

                        document.querySelectorAll('#genre-section input[type="checkbox"]').forEach(checkbox => checkbox.required = false);
                        // Removed platform checkbox required false

                        if (selectedDevlogType === 'Poll') {
                            if (pollSection) pollSection.classList.remove('hidden');
                            form.querySelector('#poll-question')?.setAttribute('required', 'true');
                            form.querySelectorAll('.poll-option-input').forEach(input => input.setAttribute('required', 'true'));
                            updateRemovePollOptionButtons();
                        }
                        // Hide HTML game code/URL section for Devlogs
                        if (htmlGameLinkCodeSection) htmlGameLinkCodeSection.classList.add('hidden');
                    } else { // HTML Game
                        if (devlogTypeSection) devlogTypeSection.classList.add('hidden');
                        if (genreSection) genreSection.classList.remove('hidden');
                        // Removed platformSection.classList.remove('hidden');
                        // Removed pricingSection.classList.remove('hidden');
                        if (commentsStatusSection) commentsStatusStatusSection.classList.remove('hidden');
                        if (linkedGamePromoSection) linkedGamePromoSection.classList.add('hidden');
                        if (htmlGamePollToggle) htmlGamePollToggle.classList.remove('hidden');
                        if (deviceCompatibilitySection) deviceCompatibilitySection.classList.remove('hidden'); // NEW

                        if (htmlGameUrlInput) {
                            // HTML Game requires either URL or Code
                            htmlGameUrlInput.removeAttribute('required'); // Will be handled by custom validation
                        }
                        if (htmlGameUrlLabel) htmlGameUrlLabel.textContent = 'HTML Game URL (Optional)';
                        if (htmlGameUrlHelp) htmlGameUrlHelp.textContent = '(Link to your hosted HTML game. If both URL and code are provided, URL will be used.)';
                        
                        // Show HTML game code/URL section for HTML Game post type
                        if (htmlGameLinkCodeSection) htmlGameLinkCodeSection.classList.remove('hidden');


                        // Poll option for HTML Game
                        if (addHtmlGamePoll) {
                             if (pollSection) pollSection.classList.remove('hidden');
                             form.querySelector('#poll-question')?.setAttribute('required', 'true');
                             form.querySelectorAll('.poll-option-input').forEach(input => input.setAttribute('required', 'true'));
                             updateRemovePollOptionButtons();
                        }
                    }
                    console.log("pollSection hidden after toggle:", pollSection.classList.contains('hidden'));
                    // Re-run media section toggle as its visibility depends on post type
                    toggleMediaSectionsInternal();
                }
                postTypeSelect.addEventListener('change', togglePostTypeFieldsInternal);
                devlogTypeSelect?.addEventListener('change', togglePostTypeFieldsInternal);
                addHtmlGamePollRadios.forEach(radio => radio.addEventListener('change', togglePostTypeFieldsInternal));

                // Only initialize visibility if not in editing mode (i.e., for new posts)
                if (!editingPostId) {
                    toggleMediaSectionsInternal();
                    togglePostTypeFieldsInternal();
                    selectedGenres = []; // Clear genres for new post
                    renderGenreCheckboxes(genreCheckboxesContainer); // Re-render to clear checkboxes
                }

                // Genre search functionality
                genreSearchInput.addEventListener('input', (e) => {
                    renderGenreCheckboxes(genreCheckboxesContainer, e.target.value);
                });
            }
        }

        // Opens the post modal and pre-fills it for editing.
        function openEditModal(postId) {
            const post = allFetchedPosts.find(p => p.id === postId);
            if (!post) {
                showAlert("Post not found for editing!");
                return;
            }

            editingPostId = postId; // Set the global editingPostId

            // Render the post page form into the modal content area
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button id="close-modal-btn" class="modal-action-btn"><i class="fas fa-arrow-left"></i></button>
                    <div class="flex gap-2">
                        <button id="share-post-btn" class="modal-action-btn" data-post-id="${postId}"><i class="fa-solid fa-share"></i></button>
                        <button id="fullscreen-toggle-btn" class="modal-action-btn"><i class="fas fa-expand"></i></button>
                    </div>
                </div>
                <div id="edit-form-container"></div>
            `;
            postModal.classList.remove('hidden'); // Show the modal
            document.getElementById('close-modal-btn').addEventListener('click', closePostModal);
            document.getElementById('fullscreen-toggle-btn').addEventListener('click', () => toggleFullscreen(modalContent));
            
            // Before rendering, set selectedGenres from the post being edited
            selectedGenres = post.genres || []; 
            
            // Render the form directly into the edit-form-container
            const editFormContainer = document.getElementById('edit-form-container');
            renderPostPage(editFormContainer);
            
            // Now, populate the form fields
            const form = editFormContainer.querySelector('#post-form'); 
            
            if (form) {
                form.querySelector('#game-title').value = post.title || '';
                form.querySelector('#description').value = post.description || '';
                form.querySelector('#char-count').textContent = `${post.description?.length || 0}/1000`;
                form.querySelector('#html-game-url').value = post.htmlGameUrl || ''; // Changed
                form.querySelector('#html-game-code').value = post.htmlGameCode || ''; // New
                form.querySelector('#made-with').value = post.madeWith || ''; // Still madeWith, but label changed
                form.querySelector('#general').value = post.general || '';
                form.querySelector('#reason').value = post.reason || '';
                form.querySelector('#tags').value = post.tags?.join(', ') || '';

                // Set Post Type and disable it
                const postTypeSelect = form.querySelector('#post-type');
                postTypeSelect.value = post.postType || 'HTML Game'; // Changed default
                postTypeSelect.disabled = true;

                // Set Devlog Type if applicable
                const devlogTypeSelect = form.querySelector('#devlog-type');
                if (post.postType === 'Devlog' && post.devlogType) {
                    devlogTypeSelect.value = post.devlogType;
                }

                // Populate poll fields if devlogType is 'Poll' or if it's an HTML Game with a poll
                const addHtmlGamePollRadios = form.querySelectorAll('input[name="add-html-game-poll"]'); // Changed
                const pollSection = form.querySelector('#poll-section');

                if ((post.postType === 'Devlog' && post.devlogType === 'Poll' && post.poll) || 
                    (post.postType === 'HTML Game' && post.poll)) { // Changed
                    
                    if (pollSection) {
                        pollSection.classList.remove('hidden');
                        pollSection.querySelectorAll('input, button').forEach(element => {
                            element.disabled = true;
                            element.classList.add('opacity-50', 'cursor-not-allowed');
                        });
                        const pollMessage = document.createElement('p');
                        pollMessage.className = 'text-sm text-red-600 mb-4';
                        pollMessage.textContent = 'This post already has a poll. Polls cannot be modified or deleted after creation.';
                        pollSection.prepend(pollMessage);
                    }

                    form.querySelector('#poll-question').value = post.poll.question || '';
                    const pollOptionsContainer = form.querySelector('#poll-options-container');
                    pollOptionsContainer.innerHTML = '';
                    post.poll.options.forEach((option, index) => {
                        const newOptionDiv = document.createElement('div');
                        newOptionDiv.className = 'flex gap-2';
                        newOptionDiv.innerHTML = `
                            <input type="text" class="poll-option-input w-full p-3 input-bg rounded-md" placeholder="Option ${index + 1}" value="${option.text}" required disabled>
                            <button type="button" class="remove-poll-option-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md hidden" disabled><i class="fas fa-minus"></i></button>
                        `;
                        pollOptionsContainer.appendChild(newOptionDiv);
                    });
                    if (post.postType === 'HTML Game' && post.poll) { // Changed
                        form.querySelector('input[name="add-html-game-poll"][value="true"]').checked = true; // Changed
                        addHtmlGamePollRadios.forEach(radio => { // Changed
                            radio.disabled = true;
                            radio.closest('label').classList.add('opacity-50', 'cursor-not-allowed');
                        });
                    }
                } else if (post.postType === 'HTML Game') { // Changed
                    form.querySelector('input[name="add-html-game-poll"][value="false"]').checked = true; // Changed
                }

                // NEW: Set Device Compatibility
                if (post.deviceCompatibility) {
                    const deviceCompatibilityRadio = form.querySelector(`input[name="device-compatibility"][value="${post.deviceCompatibility}"]`);
                    if (deviceCompatibilityRadio) deviceCompatibilityRadio.checked = true;
                }


                // Set Media Type and links
                if (post.mediaType) {
                    const mediaRadio = form.querySelector(`input[name="media-type"][value="${post.mediaType}"]`);
                    if (mediaRadio) mediaRadio.checked = true;
                }
                form.querySelector('#trailer-link').value = post.trailerLink || '';
                form.querySelector('#image-url').value = post.imageUrl || '';
                form.querySelector('#custom-youtube-link-text').value = post.customYoutubeLinkText || '';

                // Removed Pricing pre-fill

                // Set AI Content
                if (post.aiContent) {
                    const aiRadio = form.querySelector(`input[name="ai-content"][value="${post.aiContent}"]`);
                    if (aiRadio) aiRadio.checked = true;
                }

                // Removed Platforms pre-fill

                // Set Comments Allowed
                if (post.allowComments !== undefined) {
                    const commentsRadio = form.querySelector(`input[name="allow-comments"][value="${post.allowComments}"]`);
                    if (commentsRadio) commentsRadio.checked = true;
                }

                // Set Linked Game Promo (only if Devlog)
                if (post.postType === 'Devlog' && post.linkedGamePromoId) {
                    form.querySelector('#linked-game-promo').value = post.linkedGamePromoId;
                }

                // Re-run toggle functions to ensure correct visibility based on pre-filled data
                const mediaTypeRadios = form.querySelectorAll('input[name="media-type"]');
                const youtubeLinkSection = form.querySelector('#youtube-link-section');
                const imageLinkSection = form.querySelector('#image-link-section');
                const customYoutubeLinkSection = form.querySelector('#custom-youtube-text-section'); 
                const youtubeLinkHelp = form.querySelector('.youtube-link-help');
                const imageLinkHelp = form.querySelector('.image-link-help');
                const htmlGameUrlInput = form.querySelector('#html-game-url'); // Changed
                const htmlGameCodeInput = form.querySelector('#html-game-code'); // New
                const htmlGameLinkCodeSection = form.querySelector('#html-game-link-code-section'); // New
                const htmlGameUrlLabel = form.querySelector('#html-game-url-label'); // New
                const htmlGameUrlHelp = form.querySelector('.html-game-url-help'); // New

                const devlogTypeSection = form.querySelector('#devlog-type-section');
                const htmlGamePollToggle = form.querySelector('#html-game-poll-toggle'); // Changed
                const genreSection = form.querySelector('#genre-section');
                const deviceCompatibilitySection = form.querySelector('#device-compatibility-section'); // NEW
                // Removed platformSection
                // Removed pricingSection
                const commentsStatusSection = form.querySelector('#comments-status-section');
                const linkedGamePromoSection = form.querySelector('#linked-game-promo-section');

                function toggleMediaSectionsEdit() {
                    const selectedMedia = form.querySelector('input[name="media-type"]:checked')?.value;
                    console.log("toggleMediaSectionsEdit called. Selected Media:", selectedMedia);

                    const trailerLinkInput = form.querySelector('#trailer-link');
                    const imageUrlInput = form.querySelector('#image-url');
                    const customYoutubeLinkTextInput = form.querySelector('#custom-youtube-link-text');
                    const htmlGameUrlInput = form.querySelector('#html-game-url');
                    const htmlGameCodeInput = form.querySelector('#html-game-code');

                    if (youtubeLinkSection) youtubeLinkSection.classList.add('hidden');
                    if (imageLinkSection) imageLinkSection.classList.add('hidden');
                    if (customYoutubeLinkSection) customYoutubeLinkSection.classList.add('hidden');
                    // HTML Game URL/Code section visibility is controlled by post type, not media type for editing
                    // if (htmlGameLinkCodeSection) htmlGameLinkCodeSection.classList.add('hidden'); // This should not be here

                    trailerLinkInput.removeAttribute('required');
                    imageUrlInput.removeAttribute('required');
                    customYoutubeLinkTextInput.removeAttribute('required');
                    htmlGameUrlInput.removeAttribute('required');
                    htmlGameCodeInput.removeAttribute('required');

                    if (selectedMedia === 'combo') {
                        if (youtubeLinkSection) youtubeLinkSection.classList.remove('hidden');
                        if (imageLinkSection) imageLinkSection.classList.remove('hidden');
                        if (customYoutubeLinkSection) customYoutubeLinkSection.classList.remove('hidden');
                        
                        if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Required for Combo. Example: https://youtu.be/dQw4w9WgXcQ)';
                        if (imageLinkHelp) imageLinkHelp.textContent = '(Required for Combo. Example: https://example.com/your-game-screenshot.png)';
                        trailerLinkInput.setAttribute('required', 'true');
                        imageUrlInput.setAttribute('required', 'true');
                        customYoutubeLinkTextInput.setAttribute('required', 'true');
                    } else if (selectedMedia === 'youtube') {
                        if (youtubeLinkSection) youtubeLinkSection.classList.remove('hidden');
                        if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Optional. Example: https://youtu.be/dQw4w9WgXcQ)'; 
                        trailerLinkInput.setAttribute('required', 'true');
                    } else if (selectedMedia === 'image') {
                        if (imageLinkSection) imageLinkSection.classList.remove('hidden');
                        if (imageLinkHelp) imageLinkLinkHelp.textContent = '(Optional. Example: https://example.com/your-game-screenshot.png)';
                        imageUrlInput.setAttribute('required', 'true');
                    } else if (selectedMedia === 'html_embed') { // New HTML embed
                        // No specific required fields for HTML embed media type, as the game itself is the primary content.
                        // The game URL/Code fields are handled by the HTML Game post type logic.
                    } else { 
                        if (youtubeLinkHelp) youtubeLinkHelp.textContent = '(Optional. Example: https://youtu.be/dQw4w9WgXcQ)';
                        if (imageLinkHelp) imageLinkHelp.textContent = '(Optional. Example: https://example.com/your-game-screenshot.png)';
                    }
                }
                mediaTypeRadios.forEach(radio => radio.addEventListener('change', toggleMediaSectionsEdit));
                toggleMediaSectionsEdit();

                function togglePostTypeFieldsEdit() {
                    const selectedPostType = postTypeSelect.value;
                    const selectedDevlogType = devlogTypeSelect?.value;
                    const addHtmlGamePoll = form.querySelector('input[name="add-html-game-poll"]:checked')?.value === 'true'; // Changed

                    if (devlogTypeSection) devlogTypeSection.classList.add('hidden');
                    if (htmlGamePollToggle) htmlGamePollToggle.classList.add('hidden'); // Changed
                    if (pollSection) pollSection.classList.add('hidden');
                    form.querySelector('#poll-question')?.removeAttribute('required');
                    form.querySelectorAll('.poll-option-input').forEach(input => input.removeAttribute('required'));
                    if (deviceCompatibilitySection) deviceCompatibilitySection.classList.add('hidden'); // NEW

                    console.log("togglePostTypeFieldsEdit: selectedPostType =", selectedPostType, "selectedDevlogType =", selectedDevlogType, "addHtmlGamePoll =", addHtmlGamePoll);


                    if (selectedPostType === 'Devlog') {
                        if (devlogTypeSection) devlogTypeSection.classList.remove('hidden');
                        if (genreSection) genreSection.classList.add('hidden');
                        // Removed platformSection.classList.add('hidden');
                        // Removed pricingSection.classList.add('hidden');
                        if (commentsStatusSection) commentsStatusSection.classList.add('hidden');
                        if (linkedGamePromoSection) linkedGamePromoSection.classList.remove('hidden');
                        if (deviceCompatibilitySection) deviceCompatibilitySection.classList.add('hidden'); // NEW

                        if (htmlGameUrlInput) {
                            htmlGameUrlInput.removeAttribute('required');
                        }
                        if (htmlGameUrlLabel) htmlGameUrlLabel.textContent = 'HTML Game URL (Optional)';
                        if (htmlGameUrlHelp) htmlGameUrlHelp.textContent = '(Link to your hosted HTML game. Optional for Devlog.)';

                        if (selectedDevlogType === 'Poll') {
                            if (pollSection) pollSection.classList.remove('hidden');
                            form.querySelector('#poll-question')?.setAttribute('required', 'true');
                            form.querySelectorAll('.poll-option-input').forEach(input => input.setAttribute('required', 'true'));
                            if (post.poll) {
                                pollSection.querySelectorAll('input, button').forEach(element => {
                                    element.disabled = true;
                                    element.classList.add('opacity-50', 'cursor-not-allowed');
                                });
                            } else {
                                updateRemovePollOptionButtons();
                            }
                        }
                        // Hide HTML game code/URL section for Devlogs
                        if (htmlGameLinkCodeSection) htmlGameLinkCodeSection.classList.add('hidden');

                    } else { // HTML Game
                        if (devlogTypeSection) devlogTypeSection.classList.add('hidden');
                        if (genreSection) genreSection.classList.remove('hidden');
                        // Removed platformSection.classList.remove('hidden');
                        // Removed pricingSection.classList.remove('hidden');
                        if (commentsStatusSection) commentsStatusSection.classList.remove('hidden');
                        if (linkedGamePromoSection) linkedGamePromoSection.classList.add('hidden');
                        if (htmlGamePollToggle) htmlGamePollToggle.classList.remove('hidden');
                        if (deviceCompatibilitySection) deviceCompatibilitySection.classList.remove('hidden'); // NEW

                        if (htmlGameUrlInput) {
                            htmlGameUrlInput.removeAttribute('required'); // Will be handled by custom validation
                        }
                        if (htmlGameUrlLabel) htmlGameUrlLabel.textContent = 'HTML Game URL (Optional)';
                        if (htmlGameUrlHelp) htmlGameUrlHelp.textContent = '(Link to your hosted HTML game. If both URL and code are provided, URL will be used.)';
                        
                        // Show HTML game code/URL section for HTML Game post type
                        if (htmlGameLinkCodeSection) htmlGameLinkCodeSection.classList.remove('hidden');


                        // Poll option for HTML Game
                        if (addHtmlGamePoll) { // Changed
                             if (pollSection) pollSection.classList.remove('hidden');
                             form.querySelector('#poll-question')?.setAttribute('required', 'true');
                             form.querySelectorAll('.poll-option-input').forEach(input => input.setAttribute('required', 'true'));
                            if (post.poll) {
                                pollSection.querySelectorAll('input, button').forEach(element => {
                                    element.disabled = true;
                                    element.classList.add('opacity-50', 'cursor-not-allowed');
                                });
                            } else {
                                updateRemovePollOptionButtons();
                            }
                        }
                    }
                    console.log("pollSection hidden after toggle:", pollSection.classList.contains('hidden'));
                    // Re-run media section toggle as its visibility depends on post type
                    toggleMediaSectionsEdit();
                }
                postTypeSelect.addEventListener('change', togglePostTypeFieldsEdit);
                devlogTypeSelect?.addEventListener('change', togglePostTypeFieldsEdit);
                addHtmlGamePollRadios.forEach(radio => radio.addEventListener('change', togglePostTypeFieldsEdit)); // Changed
                togglePostTypeFieldsEdit();

                // Update submit button text
                form.querySelector('#submit-post-btn').textContent = 'Update Post';
                
                // Add event listener for share button
                document.getElementById('share-post-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const shareLink = `https://htmlitweb.github.io/?postId=${postId}`; // Updated URL
                    copyToClipboard(shareLink);
                    showAlert("Link copied to clipboard!");
                });

                // Re-render genre checkboxes to reflect selected genres from the post
                const genreSearchInput = form.querySelector('#genre-search');
                const genreCheckboxesContainerInModal = form.querySelector('#genre-checkboxes');
                renderGenreCheckboxes(genreCheckboxesContainerInModal, genreSearchInput.value);
            } else {
                console.error("Form element not found in modal after rendering.");
            }
        }
        
        // Renders the search page.
        function renderSearchPage() {
            contentSearch.innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <h2 class="text-3xl font-bold mb-6 text-center text-white">Search for Games</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <input type="text" id="search-input" class="w-full p-3 input-bg rounded-md" placeholder="Search by title, genre, tags, technologies..."> <!-- Updated placeholder -->
                        <button id="search-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-md">Search</button>
                    </div>
                    <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="col-span-full text-center text-gray-400">Please enter a search term.</p>
                    </div>
                </div>
            `;
            document.getElementById('search-btn').addEventListener('click', handleSearch);
            document.getElementById('search-input').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
        }

        // Renders the user's own posts page.
        function renderMyPostsPage() {
            const myPosts = allFetchedPosts.filter(p => p.authorId === currentUser?.uid);
            renderPostsGrid(contentMyPosts, myPosts, "My Posts", true, true, true); // Removed pricing filter
        }

		// Renders the About page content.
		function renderAboutPage() {
			contentAbout.innerHTML = `
				<div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg text-center">
					<h2 class="text-3xl sm:text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">About HTMLIT</h2>
					<p class="text-base sm:text-lg text-gray-300 mb-6">
						HTMLIT is a dedicated platform for developers to anonymously share and showcase their HTML games. Whether you're sharing a small experiment, a game jam entry, or a fully developed browser game, HTMLIT creates a welcoming space where creators and players can interact without judgment or pressure.
					</p>
					<p class="text-base sm:text-lg text-gray-300 mb-6">
						Our goal is to spark discovery, inspiration, and connection in the HTML game development community. Players can explore a curated feed of unique browser games, while developers can gain visibility and feedback without revealing personal details or dealing with social media stress.
					</p>
					<p class="text-gray-400 text-sm sm:text-base mb-6">
						Built with love for the indie scene, HTMLIT is completely free and privacy-first. Your creativity matters here. Share what you love, get inspired, and join a movement that values honesty, experimentation, and play.
					</p>
					<p class="text-gray-500 text-xs sm:text-sm mt-8">
						Made by <a href="https://fillabrona.itch.io/" target="_blank" class="text-blue-400 underline hover:text-blue-300">Fillabrona</a> the creator of PostItch</a>
					</p>
                    <div class="mt-8 pt-6 border-t border-gray-700 flex flex-col sm:flex-row justify-center gap-4">
                        <button id="share-website-btn" class="btn-primary flex-1 text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
                            <i class="fa-solid fa-share mr-2"></i> Share HTMLIT Website
                        </button>
                        <button id="open-settings-from-about" class="btn-primary flex-1 text-white font-bold py-3 px-6 rounded-md flex items-center justify-center gap-2">
                            <i class="fas fa-cog mr-2"></i> Open Settings
                        </button>
                    </div>
				</div>
			`;
            document.getElementById('open-settings-from-about').addEventListener('click', () => {
                switchTab('settings');
            });
            // Event listener for "Share Website" button
            document.getElementById('share-website-btn').addEventListener('click', () => {
                const websiteLink = "https://htmlitweb.github.io/?section=community"; // Updated URL
                copyToClipboard(websiteLink);
                showAlert("Website link copied to clipboard!");
            });
		}
        
        // Renders the Community Rules page content.
        function renderRulesPage() {
            contentRules.innerHTML = `
                <div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">Community Rules</h2>
                    <ul class="space-y-4">
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Be Respectful:</strong> Treat everyone with kindness. Harassment, hate speech, or personal attacks will not be tolerated.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Relevant Content Only:</strong> All posts must relate to an HTML game or devlog. Off-topic content will be removed.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Valid HTML:</strong> Ensure your HTML game code is functional and safe. Malicious code will result in immediate deletion and potential banning.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>No Spamming:</strong> Do not post the same game repeatedly within a short timeframe (e.g., 7 days). Devlogs are welcome for updates.</span></li>
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Honest Representation:</strong> Be truthful about your game's features, genre, and technologies used.</span></li> <!-- Updated text -->
                        <li class="flex items-start"><i class="fas fa-check-circle text-cyan-400 mt-1 mr-3"></i><span><strong>Anonymity is Key:</strong> This platform uses anonymous sign-in. Do not attempt to de-anonymize others or share personal information.</span></li>
                    </ul>
                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-2xl font-bold mb-4 text-gray-500">Content Quality Guidelines</h3>
                        <ul class="space-y-4 text-gray-300">
                            <li class="flex items-start"><i class="fas fa-exclamation-triangle text-yellow-400 mt-1 mr-3"></i><span><strong>Image Quality:</strong> Thumbnails and images must be clear, high quality, and directly related to the game. Blurry, stretched, low-effort, or unrelated visuals may lead to your post being removed or modified. Avoid random text-heavy or poorly designed thumbnailsonly clean, appealing images are allowed.</span></li>
                            <li class="flex items-start"><i class="fas fa-robot text-red-400 mt-1 mr-3"></i><span><strong> AI Generated Content:</strong> AI-generated images that are low quality or visually unappealing will be removed. Visually appealing AI-generated content is allowed but must be clearly labeled as AI-generated. Any AI content that is misleading or lacks proper disclosure may be subject to removal.</span></li>
                            <li class="flex items-start"><i class="fas fa-align-left text-blue-400 mt-1 mr-3"></i><span><strong>Description & Marketing:</strong> Posts must have good descriptions, positive energy, and effective marketing. Bad descriptions, negative energy, bad language, horrible marketing, or false advertising will result in your post being deleted or modified.</span></li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Renders the Settings page content.
        function renderSettingsPage() {
            contentSettings.innerHTML = `
                <div class="max-w-3xl mx-auto card-bg p-4 sm:p-8 rounded-lg">
                    <h2 class="text-3xl sm:text-4xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-600">Settings</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Theme Preference</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="theme-preference" value="system" ${userSettings.theme === 'system' ? 'checked' : ''}>
                                    <span>System Preference</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="theme-preference" value="dark" ${userSettings.theme === 'dark' ? 'checked' : ''}>
                                    <span>Dark Mode</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="theme-preference" value="light" ${userSettings.theme === 'light' ? 'checked' : ''}>
                                    <span>Light Mode</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Text Size</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="text-size" value="sm" ${userSettings.textSize === 'sm' ? 'checked' : ''}>
                                    <span>Small</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="text-size" value="base" ${userSettings.textSize === 'base' ? 'checked' : ''}>
                                    <span>Medium</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="text-size" value="lg" ${userSettings.textSize === 'lg' ? 'checked' : ''}>
                                    <span>Large</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Animations</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="animations" value="true" ${userSettings.animations ? 'checked' : ''}>
                                    <span>On</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="animations" value="false" ${!userSettings.animations ? 'checked' : ''}>
                                    <span>Off</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Show Post Counts (Likes, Comments, Views, Plays)</label> <!-- Changed text -->
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="show-post-counts" value="true" ${userSettings.showPostCounts ? 'checked' : ''}>
                                    <span>On</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="show-post-counts" value="false" ${!userSettings.showPostCounts ? 'checked' : ''}>
                                    <span>Off</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Default Post Type</label>
                            <div class="custom-select">
                                <select id="default-post-type" class="w-full p-3 input-bg rounded-md">
                                    <option value="HTML Game" ${userSettings.defaultPostType === 'HTML Game' ? 'selected' : ''}>HTML Game</option> <!-- Changed -->
                                    <option value="Devlog" ${userSettings.defaultPostType === 'Devlog' ? 'selected' : ''}>Devlog</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Default Post Count Display</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="default-post-count-display" value="exact" ${userSettings.defaultPostCountDisplay === 'exact' ? 'checked' : ''}>
                                    <span>Exact Numbers (e.g., 1250)</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="default-post-count-display" value="abbreviated" ${userSettings.defaultPostCountDisplay === 'abbreviated' ? 'checked' : ''}>
                                    <span>Abbreviated (e.g., 1.3k)</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block mb-2 font-semibold text-gray-300">Automatically Open Modals Fullscreen</label>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <label class="custom-checkbox">
                                    <input type="radio" name="modal-fullscreen-setting" value="true" ${userSettings.modalFullscreen ? 'checked' : ''}>
                                    <span>Yes</span>
                                </label>
                                <label class="custom-checkbox">
                                    <input type="radio" name="modal-fullscreen-setting" value="false" ${!userSettings.modalFullscreen ? 'checked' : ''}>
                                    <span>No</span>
                                </label>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-gray-700 space-y-4">
                            <h3 class="text-xl font-bold text-red-600">Danger Zone</h3>
                            <button id="delete-all-posts-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md w-full flex items-center justify-center gap-2 transition-all duration-300">
                                <i class="fas fa-trash mr-2"></i> Delete All My Posts
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for settings changes
            contentSettings.querySelectorAll('input[name="theme-preference"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.theme = e.target.value;
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelectorAll('input[name="text-size"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.textSize = e.target.value;
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelectorAll('input[name="animations"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.animations = e.target.value === 'true';
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelectorAll('input[name="show-post-counts"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.showPostCounts = e.target.value === 'true';
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelector('#default-post-type').addEventListener('change', (e) => {
                userSettings.defaultPostType = e.target.value;
                saveUserSettings();
            });

            contentSettings.querySelectorAll('input[name="default-post-count-display"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.defaultPostCountDisplay = e.target.value;
                    applySettings();
                    saveUserSettings();
                });
            });

            contentSettings.querySelectorAll('input[name="modal-fullscreen-setting"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userSettings.modalFullscreen = e.target.value === 'true';
                    saveUserSettings();
                });
            });

            // Event listener for "Delete All My Posts" button
            document.getElementById('delete-all-posts-btn').addEventListener('click', async () => {
                if (!currentUser || !isAuthReady) {
                    showAlert("Please wait for authentication to complete before deleting posts.");
                    return;
                }

                const confirmStep1 = await showConfirm("Are you absolutely sure you want to delete ALL your posts? This action cannot be undone. Click 'Yes' to proceed.");
                if (!confirmStep1) {
                    return;
                }

                const confirmationText = "I want to delete all my posts from HTMLIT"; // Changed text
                const userConfirmedInput = await showConfirmWithInput(
                    "This is your final warning: ALL your posts will be permanently deleted. There is NO UNDO.",
                    confirmationText
                );
                
                if (userConfirmedInput) {
                    try {
                        const postsRef = collection(db, `artifacts/${appId}/public/data/posts`);
                        const q = query(postsRef, where("authorId", "==", currentUser.uid));
                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            showAlert("You have no posts to delete.");
                            return;
                        }

                        const batch = writeBatch(db);
                        querySnapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();
                        showAlert("All your posts have been successfully deleted.").then(() => {
                            switchTab('community');
                        });
                    } catch (error) {
                        console.error("Error deleting all posts:", error);
                        showAlert(`Failed to delete all posts: ${error.message || error}. Please check your browser console.`);
                    }
                } else {
                    showAlert("Deletion cancelled or incorrect confirmation text.");
                }
            });
        }
        
        // This function now uses onSnapshot to keep 'allFetchedPosts' array updated in real-time.
        function listenForPostsRealtime() {
            const postsColRef = collection(db, `artifacts/${appId}/public/data/posts`);
            onSnapshot(postsColRef, (snapshot) => {
                // Create a temporary map for quick lookup of old posts
                const oldPostsMap = new Map(allFetchedPosts.map(p => [p.id, p]));

                // Update allFetchedPosts first
                allFetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allFetchedPosts.sort((a, b) => {
                    const dateA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                let shouldFullReRender = false; // Flag to decide if we need to re-render the entire grid

                snapshot.docChanges().forEach(change => {
                    const changedPost = { id: change.doc.id, ...change.doc.data() };
                    const oldPost = oldPostsMap.get(changedPost.id);

                    if (change.type === "added") {
                        console.log("Post added:", changedPost.id);
                        shouldFullReRender = true; // A new post might affect sorting/filtering, so re-render
                    } else if (change.type === "removed") {
                        console.log("Post removed:", changedPost.id);
                        shouldFullReRender = true; // Removal definitely affects the grid
                    } else if (change.type === "modified") {
                        console.log("Post modified:", changedPost.id);
                        let nonCountFieldChanged = false;
                        if (oldPost) {
                            for (const key in changedPost) {
                                // Skip these for the 'non-count' check, as they are handled separately or expected to change
                                if (['likes', 'comments', 'views', 'visits', 'createdAt'].includes(key)) {
                                    continue;
                                }
                                // Deep compare for objects/arrays, simple compare for primitives
                                if (JSON.stringify(changedPost[key]) !== JSON.stringify(oldPost[key])) {
                                    nonCountFieldChanged = true;
                                    break;
                                }
                            }
                            // Also check if any field was added or removed (excluding the count fields)
                            if (Object.keys(changedPost).length !== Object.keys(oldPost).length) {
                                const oldKeys = new Set(Object.keys(oldPost).filter(k => !['likes', 'comments', 'views', 'visits', 'createdAt'].includes(k)));
                                const newKeys = new Set(Object.keys(changedPost).filter(k => !['likes', 'comments', 'views', 'visits', 'createdAt'].includes(k)));
                                if (oldKeys.size !== newKeys.size || ![...oldKeys].every(key => newKeys.has(key))) {
                                    nonCountFieldChanged = true;
                                }
                            }
                        } else {
                            // If oldPost is null, it means it's a new post or somehow not in oldPostsMap,
                            // so treat as a full re-render needed.
                            nonCountFieldChanged = true;
                        }

                        if (!nonCountFieldChanged) {
                            console.log("Only counts or timestamp changed for post:", changedPost.id);
                            // Find the existing card and update its counts directly
                            const cardElement = document.querySelector(`.card-bg[data-id="${changedPost.id}"]`);
                            if (cardElement) {
                                // Update likes count
                                const likeCountSpan = cardElement.querySelector('.like-btn span');
                                if (likeCountSpan) {
                                    likeCountSpan.textContent = formatNumberForDisplay(changedPost.likes?.length || 0);
                                    const heartIcon = cardElement.querySelector('.like-btn i');
                                    if (heartIcon) {
                                        if (changedPost.likes?.includes(currentUser?.uid)) {
                                            heartIcon.classList.replace('far', 'fas');
                                            heartIcon.classList.add('text-red-500');
                                        } else {
                                            heartIcon.classList.replace('fas', 'far');
                                            heartIcon.classList.remove('text-red-500');
                                        }
                                    }
                                }

                                // Update comments count
                                const commentCountSpan = cardElement.querySelector('.comment-btn span');
                                if (commentCountSpan) {
                                    commentCountSpan.textContent = formatNumberForDisplay(changedPost.comments?.length || 0);
                                }

                                // Update views count
                                const viewCountSpan = cardElement.querySelector('.fa-eye + span');
                                if (viewCountSpan) {
                                    viewCountSpan.textContent = formatNumberForDisplay(changedPost.views || 0);
                                }

                                // Update visits count (for HTML Games)
                                const visitCountSpan = cardElement.querySelector('.fa-gamepad + span');
                                if (visitCountSpan) {
                                    visitCountSpan.textContent = formatNumberForDisplay(changedPost.visits || 0);
                                }
                            }
                        } else {
                            console.log("Other fields changed for post:", changedPost.id);
                            shouldFullReRender = true; // Other changes mean re-render the whole grid
                        }
                    }
                });

                // Only re-render the entire grid if structural changes occurred (added, removed, or non-count modifications)
                if (shouldFullReRender) {
                    const activeTab = document.querySelector('.nav-item.active')?.getAttribute('data-tab') || 'community';
                    if (activeTab === 'community') {
                        renderCommunityPage();
                    } else if (activeTab === 'my-posts') {
                        renderMyPostsPage();
                    } else if (activeTab === 'html-games') {
                        renderHtmlGamesPage();
                    } else if (activeTab === 'devlogs') {
                        renderDevlogsPage();
                    } else if (activeTab === 'search') {
                        handleSearch(); // Search results might need a full re-evaluation
                    }
                }

                // Always update the open post modal if it exists and the post it's displaying has changed
                if (isPostModalOpen) {
                    const currentPostId = modalContent.querySelector('.modal-action-btn[data-post-id]')?.dataset.postId || editingPostId;
                    if (currentPostId) {
                        const updatedPostInAllFetched = allFetchedPosts.find(p => p.id === currentPostId);
                        if (updatedPostInAllFetched) {
                            // Re-open the modal with the updated data, but don't increment view again
                            openPostModal(currentPostId, false, false); 
                        } else {
                            // If the post was deleted while modal was open
                            closePostModal();
                            showAlert("The post you were viewing has been deleted.");
                        }
                    }
                }
            }, error => {
                console.error("Error listening for posts:", error);
                showAlert(`Error fetching posts: ${error.message || error}. Please check your Firebase Security Rules.`);
            });
        }

        // Handles the submission of a new post to Firestore.
        async function handlePostSubmit(e) {
            e.preventDefault();
            const submitBtn = e.submitter;
            if (!submitBtn) return;

            console.log("handlePostSubmit called. editingPostId:", editingPostId);

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait for authentication to complete before posting. If this persists, refresh the page.");
                submitBtn.disabled = false;
                submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                return;
            }

            const form = e.target;
            const postType = form.querySelector('#post-type').value;
            const genres = [...selectedGenres]; 
            // Removed platforms as it's no longer needed
            const mediaType = form.querySelector('input[name="media-type"]:checked').value;
            const aiContent = form.querySelector('input[name="ai-content"]:checked')?.value;
            const tagsInput = form.querySelector('#tags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag !== '') : [];
            const htmlGameUrl = form.querySelector('#html-game-url').value.trim(); // Changed from itchLink
            const htmlGameCode = form.querySelector('#html-game-code').value.trim(); // New
            const allowComments = form.querySelector('input[name="allow-comments"]:checked')?.value === 'true';
            const linkedGamePromoId = form.querySelector('#linked-game-promo')?.value || null;
            const devlogType = form.querySelector('#devlog-type')?.value || null;
            const addHtmlGamePoll = form.querySelector('input[name="add-html-game-poll"]:checked')?.value === 'true'; // Changed
            const deviceCompatibility = form.querySelector('input[name="device-compatibility"]:checked')?.value; // NEW

            // Poll data if devlogType is 'Poll' or if postType is 'HTML Game' and addHtmlGamePoll is true
            let pollData = null;
            if ((postType === 'Devlog' && devlogType === 'Poll') || (postType === 'HTML Game' && addHtmlGamePoll)) { // Changed
                const pollQuestion = form.querySelector('#poll-question').value.trim();
                const pollOptions = [...form.querySelectorAll('.poll-option-input')].map(input => ({
                    text: input.value.trim(),
                    votes: 0
                }));

                if (!pollQuestion) {
                    showAlert("Poll question cannot be empty.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (pollOptions.length < 2 || pollOptions.length > 5 || pollOptions.some(opt => !opt.text)) {
                    showAlert("Please provide between 2 and 5 non-empty poll options.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                pollData = { question: pollQuestion, options: pollOptions, voters: [] };
            }


            // Validation based on post type
            if (postType === 'HTML Game') { // Changed
                if (genres.length < 3) {
                    showAlert("For HTML Game, please select at least 3 genres.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // Removed platform validation
                // HTML Game requires either URL or Code
                if (!htmlGameUrl && !htmlGameCode) {
                    showAlert("For HTML Game, please provide either an HTML Game URL or paste the HTML Game Code.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // NEW: HTML Game code size check
                if (htmlGameCode && new TextEncoder().encode(htmlGameCode).length > 1048576) { // 1MB = 1048576 bytes
                    showAlert("HTML Game code exceeds 1MB. Please use the HTML Game URL option for larger codebases.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // Validate device compatibility
                if (!deviceCompatibility) { // NEW
                    showAlert("Please select the device compatibility for your HTML Game.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                // No spamming rule for HTML Game: check if the same HTML Game was posted recently by the same user
                if (!editingPostId) {
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const recentPost = allFetchedPosts.find(p => 
                        p.authorId === currentUser.uid && 
                        (p.htmlGameUrl === htmlGameUrl || p.htmlGameCode === htmlGameCode) && // Check both
                        p.createdAt && p.createdAt.toDate() > sevenDaysAgo
                    );
                    if (recentPost) {
                        showAlert("You have already posted this HTML game recently. Please wait at least 7 days before posting the same game again to avoid spamming.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Post';
                        return;
                    }
                }
            } else if (postType === 'Devlog') {
                if (!linkedGamePromoId) {
                    showAlert("For Devlog, you must select one of your HTML Games to link to."); // Changed text
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (linkedGamePromoId) {
                    const linkedPostExists = allFetchedPosts.some(p => p.id === linkedGamePromoId && p.postType === 'HTML Game' && p.authorId === currentUser.uid); // Changed
                    if (!linkedPostExists) {
                        showAlert("The selected linked HTML game is invalid or not one of your own."); // Changed text
                        submitBtn.disabled = false;
                        submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                        return;
                    }
                }
            }

            if (!aiContent) {
                showAlert("Please indicate if this game contains AI generated content.");
                submitBtn.disabled = false;
                submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                return;
            }

            let trailerLink = '';
            let imageUrl = '';
            let customYoutubeLinkText = '';

            if (mediaType === 'youtube' || mediaType === 'combo') {
                trailerLink = form.querySelector('#trailer-link').value.trim();
                if (mediaType === 'combo' && !trailerLink) { 
                    showAlert("For Combo media type, the YouTube Trailer/Gameplay Link is required.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (trailerLink && !getYouTubeVideoId(trailerLink)) {
                    showAlert("Please enter a valid YouTube link (e.g., youtube.com/watch?v=... or youtu.be/...).");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
            }
            if (mediaType === 'image' || mediaType === 'combo') {
                imageUrl = form.querySelector('#image-url').value.trim();
                if (mediaType === 'combo' && !imageUrl) { 
                    showAlert("For Combo media type, the Image URL is required.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
                if (imageUrl && !imageUrl.match(/^https?:\/\/[^\s$.?#].[^\s]*$/i)) {
                    showAlert("Please enter a valid URL for the image link.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
            }
            if (mediaType === 'combo') {
                customYoutubeLinkText = form.querySelector('#custom-youtube-link-text').value.trim();
                if (!customYoutubeLinkText) {
                    showAlert("For Combo media type, Custom YouTube Link Text is required.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
                    return;
                }
            }
            // If mediaType is 'none' or 'html_embed', trailerLink and imageUrl will remain empty, which is correct.

            const basePostData = {
                authorId: currentUser.uid,
                title: form.querySelector('#game-title').value.trim(),
                description: form.querySelector('#description').value.trim(),
                htmlGameUrl: htmlGameUrl, // Changed from itchLink
                htmlGameCode: htmlGameCode, // New
                mediaType: mediaType,
                trailerLink: trailerLink,
                imageUrl: imageUrl,
                customYoutubeLinkText: customYoutubeLinkText,
                postType: postType,
                madeWith: form.querySelector('#made-with').value.trim(), // Still madeWith key
                aiContent: aiContent,
                tags: tags,
                allowComments: allowComments,
                general: form.querySelector('#general').value.trim(),
                reason: form.querySelector('#reason').value.trim(),
                deviceCompatibility: postType === 'HTML Game' ? deviceCompatibility : deleteField(), // NEW: Only store for HTML Game posts
            };

            try {
                if (editingPostId) {
                    const postRef = doc(db, `artifacts/${appId}/public/data/posts`, editingPostId);
                    const existingPost = allFetchedPosts.find(p => p.id === editingPostId);

                    if (!existingPost) {
                        showAlert("Error: Existing post not found for update.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Update Post';
                        return;
                    }

                    let updatePayload = {
                        ...basePostData,
                        likes: existingPost.likes || [],
                        comments: existingPost.comments || [],
                        views: existingPost.views || 0,
                        visits: existingPost.visits || 0,
                        createdAt: existingPost.createdAt,
                    };

                    if (existingPost.poll) {
                        updatePayload.poll = existingPost.poll;
                    } else {
                        if ((postType === 'Devlog' && devlogType === 'Poll') || (postType === 'HTML Game' && addHtmlGamePoll)) { // Changed
                            updatePayload.poll = pollData;
                        } else {
                            updatePayload.poll = deleteField();
                        }
                    }

                    if (postType === 'HTML Game') { // Changed
                        // Removed pricing
                        updatePayload.genres = genres;
                        // Removed platforms
                        updatePayload.linkedGamePromoId = deleteField();
                        updatePayload.devlogType = deleteField();
                    } else if (postType === 'Devlog') {
                        updatePayload.linkedGamePromoId = linkedGamePromoId;
                        updatePayload.devlogType = devlogType;
                        // Removed pricing
                        updatePayload.genres = deleteField();
                        // Removed platforms
                    }
                    
                    await updateDoc(postRef, updatePayload, { merge: true });
                    showAlert("Post updated successfully!").then(() => {
                        closePostModal();
                        displayLimit = postsPerPage;
                        switchTab('my-posts');
                    });

                } else {
                    let newPostData = {
                        ...basePostData,
                        likes: [],
                        comments: [],
                        views: 0,
                        visits: 0,
                        createdAt: serverTimestamp(),
                    };

                    if (postType === 'HTML Game') { // Changed
                        // Removed pricing
                        newPostData.genres = genres;
                        // Removed platforms
                        if (addHtmlGamePoll && pollData) { // Changed
                            newPostData.poll = pollData;
                        }
                    } else if (postType === 'Devlog') {
                        newPostData.linkedGamePromoId = linkedGamePromoId;
                        newPostData.devlogType = devlogType;
                        if (devlogType === 'Poll' && pollData) {
                            newPostData.poll = pollData;
                        }
                    }

                    await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), newPostData);
                    showAlert("Post submitted successfully!").then(() => {
                        form.reset();
                        form.querySelector('#char-count').textContent = `0/1000`;
                        
                        const mediaYoutubeRadio = form.querySelector('#media-youtube');
                        if (mediaYoutubeRadio) {
                            mediaYoutubeRadio.checked = true;
                            mediaYoutubeRadio.dispatchEvent(new Event('change'));
                        }

                        const postTypeSelect = form.querySelector('#post-type');
                        postTypeSelect.value = userSettings.defaultPostType;
                        postTypeSelect.dispatchEvent(new Event('change'));
                        
                        selectedGenres = [];
                        const genreCheckboxesContainer = form.querySelector('#genre-checkboxes');
                        renderGenreCheckboxes(genreCheckboxesContainer);
                        switchTab('my-posts');
                    });
                }
            } catch (error) {
                console.error("Error handling post:", error);
                showAlert(`Failed to ${editingPostId ? 'update' : 'submit'} post: ${error.message || error}. This often happens due to incorrect Firebase Security Rules or network issues. Please check your browser console for more details.`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editingPostId ? 'Update Post' : 'Submit Post';
            }
        }
        
        // Toggles a like on a post (adds or removes the current user's UID from the likes array).
        async function toggleLike(postId) {
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete before liking.");
                return;
            }
            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            const post = allFetchedPosts.find(p => p.id === postId);
            if (!post) {
                console.error("Post not found for liking:", postId);
                showAlert("Could not like post: Post not found.");
                return;
            }

            let newLikes = post.likes || [];
            if (newLikes.includes(currentUser.uid)) {
                newLikes = newLikes.filter(uid => uid !== currentUser.uid);
            } else {
                newLikes.push(currentUser.uid);
            }
            try {
                await updateDoc(postRef, { likes: newLikes });
            } catch (error) {
                console.error("Error toggling like:", error);
                showAlert(`Failed to toggle like: ${error.message || error}.`);
            }
        }
        
        // Handles searching for posts based on a query term.
        function handleSearch() {
            const queryTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results');
            if (!queryTerm) {
                resultsContainer.innerHTML = '<p class="col-span-full text-center text-gray-400">Please enter a search term.</p>';
                return;
            }
            const results = allFetchedPosts.filter(post =>
                post.title.toLowerCase().includes(queryTerm) ||
                post.description.toLowerCase().includes(queryTerm) ||
                (post.genres && post.genres.some(g => g.toLowerCase().includes(queryTerm))) ||
                // Removed platform from search
                (post.madeWith && post.madeWith.toLowerCase().includes(queryTerm)) || // Still madeWith key
                (post.tags && post.tags.some(t => t.toLowerCase().includes(queryTerm))) ||
                (post.aiContent && post.aiContent.toLowerCase().includes(queryTerm)) ||
                (post.devlogType && post.devlogType.toLowerCase().includes(queryTerm))
            );
            
            if (results.length > 0) {
                resultsContainer.innerHTML = results.map(post => renderPostCard(post, false)).join('');
                addCardEventListeners();
            } else {
                resultsContainer.innerHTML = '<p class="col-span-full text-center text-gray-400">No games or devlogs found matching your search.</p>';
            }
        }

        // --- MODAL LOGIC FOR INDIVIDUAL POST VIEW ---
        // Toggles fullscreen mode for a given modal element.
        function toggleFullscreen(modalElement, forceState) {
            const isFullscreen = modalElement.classList.contains('fullscreen');
            const shouldBeFullscreen = (forceState !== undefined) ? forceState : !isFullscreen;

            const backdrop = modalElement.previousElementSibling;

            if (shouldBeFullscreen) {
                modalElement.classList.add('fullscreen');
                if (backdrop) backdrop.classList.add('fullscreen');
                document.body.classList.add('modal-fullscreen-active');
                const toggleBtn = modalElement.id === 'modal-content' ? document.getElementById('fullscreen-toggle-btn') : document.getElementById('fullscreen-video-toggle-btn');
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                modalElement.classList.remove('fullscreen');
                if (backdrop) backdrop.classList.remove('fullscreen');
                document.body.classList.remove('modal-fullscreen-active');
                const toggleBtn = modalElement.id === 'modal-content' ? document.getElementById('fullscreen-toggle-btn') : document.getElementById('fullscreen-video-toggle-btn');
                if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        }

        // Toggles fullscreen specifically for the HTML game iframe within the dedicated game modal.
        function toggleGameFullscreen(gameIframeElement, forceState) {
            const isFullscreen = document.fullscreenElement === gameIframeElement;
            const shouldBeFullscreen = (forceState !== undefined) ? forceState : !isFullscreen;

            if (shouldBeFullscreen) {
                if (gameIframeElement.requestFullscreen) {
                    gameIframeElement.requestFullscreen();
                } else if (gameIframeElement.mozRequestFullScreen) { /* Firefox */
                    gameIframeElement.mozRequestFullScreen();
                } else if (gameIframeElement.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                    gameIframeElement.webkitRequestFullscreen();
                } else if (gameIframeElement.msRequestFullscreen) { /* IE/Edge */
                    gameIframeElement.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { /* Firefox */
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE/Edge */
                    document.msExitFullscreen();
                }
            }
        }

        // Opens a modal displaying detailed information about a selected post.
        async function openPostModal(postId, focusComment = false, incrementView = true) {
            isPostModalOpen = true; 
            console.log("Opening post modal for ID:", postId);

            const post = allFetchedPosts.find(p => p.id === postId);
            if (!post) {
                showAlert("Post not found!");
                isPostModalOpen = false;
                return;
            }

            if (incrementView) {
                const currentTime = Date.now();
                const lastViewTime = lastViewTimestamps.get(postId);

                if (!lastViewTime || (currentTime - lastViewTime > VIEW_COOLDOWN_MS)) {
                    try {
                        const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                        await updateDoc(postRef, { views: (post.views || 0) + 1 });
                        post.views = (post.views || 0) + 1;
                        lastViewTimestamps.set(postId, currentTime);
                        console.log(`View for post ${postId} incremented. New views: ${post.views}`);
                    } catch (error) {
                        console.error("Error incrementing view count:", error);
                    }
                } else {
                    console.log(`View for post ${postId} not incremented due to cooldown. Last view: ${((currentTime - lastViewTime) / 1000).toFixed(1)}s ago.`);
                }
            }


            let mediaHtml = '';
            let modalYoutubeLinkHtml = '';
            let playGameButtonHtml = ''; // Variable for "Play Game" button
            
            // Determine the game source if it's an HTML Game
            const gameSrc = post.postType === 'HTML Game' && (post.htmlGameUrl || post.htmlGameCode)
                ? (post.htmlGameUrl || `data:text/html;base64,${btoa(post.htmlGameCode)}`)
                : '';

            if (post.mediaType === 'youtube' && post.trailerLink) {
                const videoId = getYouTubeVideoId(post.trailerLink);
                if (videoId) {
                    const embedSrc = getYouTubeEmbedSrc(videoId, true);
                    mediaHtml = `<div class="aspect-video w-full rounded-md overflow-hidden relative">
                                    <iframe class="w-full h-full rounded-none" src="${embedSrc}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-in-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                                </div>`;
                }
            } else if (post.mediaType === 'image' && post.imageUrl) {
                mediaHtml = `<div class="w-full h-auto max-h-96 flex justify-center items-center overflow-hidden rounded-md">
                                <img src="${post.imageUrl}" alt="${post.title}" class="max-w-full max-h-full object-contain rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/800x450/101010/808080?text=Image+Not+Found';">
                            </div>`;
            } else if (post.mediaType === 'combo' && post.trailerLink && post.imageUrl) {
                mediaHtml = `<div class="w-full h-auto max-h-96 flex justify-center items-center overflow-hidden rounded-md mb-4">
                                <img src="${post.imageUrl}" alt="Custom Thumbnail" class="max-w-full max-h-full object-contain rounded-none" onerror="this.onerror=null;this.src='https://placehold.co/800x450/101010/808080?text=Custom+Thumbnail+Not+Found';">
                            </div>`;
                const videoId = getYouTubeVideoId(post.trailerLink);
                if (videoId) {
                    modalYoutubeLinkHtml = `
                        <div class="flex justify-center my-4">
                            <button id="open-video-player-btn" class="btn-primary flex items-center justify-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-md text-white font-bold hover:scale-105 transition-transform text-sm sm:text-base" data-video-id="${videoId}">
                                <i class="fab fa-youtube"></i> ${post.customYoutubeLinkText || 'Watch Trailer'}
                            </button>
                        </div>
                    `;
                }
            } else if (post.mediaType === 'html_embed') { // New HTML embed type
                // Show a placeholder for HTML embed in the post modal, the actual game plays in a separate modal
                mediaHtml = `<div class="h-48 bg-[#101010] flex flex-col items-center justify-center text-gray-500 rounded-md">
                                <i class="fas fa-code fa-4x mb-2"></i>
                                <p class="text-center text-lg">HTML Game Preview</p>
                                <p class="text-sm text-gray-600 mt-1">Click "Play Game" below to launch</p>
                            </div>`;
            }

            // Fallback content if no valid media is provided or selected (or mediaType is 'none')
            if (!mediaHtml || post.mediaType === 'none') {
                mediaHtml = `<div class="h-48 bg-[#101010] flex items-center justify-center text-gray-500 rounded-md"><i class="fas fa-image fa-4x"></i><p class="ml-4">No media available</p></div>`;
            }

            // "Play Game" button logic for HTML Game posts
            if (post.postType === 'HTML Game' && gameSrc) {
                playGameButtonHtml = `
                    <button id="play-game-btn" class="btn-primary flex items-center justify-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-md text-white font-bold hover:scale-105 transition-transform text-sm sm:text-base" data-game-src="${gameSrc}" data-device-compatibility="${post.deviceCompatibility || 'Both'}">
                        <i class="fas fa-play"></i> Play Game
                    </button>
                `;
            }

            // Render poll section if devlogType is 'Poll' or if postType is 'HTML Game' and it has a poll
            let pollHtml = '';
            if ((post.postType === 'Devlog' && post.devlogType === 'Poll' && post.poll) || (post.postType === 'HTML Game' && post.poll)) { // Changed
                const totalVotes = post.poll.options.reduce((sum, option) => sum + (option.votes || 0), 0);
                pollHtml = `
                    <div class="mt-8 border-t border-gray-700 pt-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-700">Poll: ${post.poll.question}</h3>
                        <div class="space-y-3">
                            ${post.poll.options.map((option, index) => {
                                const percentage = totalVotes > 0 ? ((option.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                                const hasVoted = post.poll.voters?.includes(currentUser?.uid);
                                return `
                                    <div class="bg-[#1a1a1a] p-3 rounded-md shadow-sm">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-gray-300 text-sm sm:text-base">${option.text}</span>
                                            <span class="text-gray-400 text-xs">${formatNumberForDisplay(option.votes || 0)} votes (${percentage}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                                            <div class="bg-[#00bcd4] h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                        <button class="vote-poll-btn btn-primary text-white font-bold py-1 px-3 rounded-md text-xs mt-2 ${hasVoted ? 'opacity-50 cursor-not-allowed' : ''}" 
                                            data-post-id="${postId}" data-option-index="${index}" ${hasVoted ? 'disabled' : ''}>
                                            ${hasVoted ? 'Voted' : 'Vote'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${totalVotes > 0 ? `<p class="text-right text-xs text-gray-500 mt-4">Total Votes: ${formatNumberForDisplay(totalVotes)}</p>` : `<p class="text-center text-gray-400 text-sm mt-4">No votes yet. Be the first to vote!</p>`}
                    </div>
                `;
            }

			modalContent.innerHTML = `
				<div class="flex justify-between items-center mb-4">
					<button id="close-modal-btn" class="modal-action-btn"><i class="fas fa-arrow-left"></i></button>
                    <div class="flex gap-2">
                        <button id="share-post-btn" class="modal-action-btn" data-post-id="${postId}"><i class="fa-solid fa-share"></i></button>
                        <button id="fullscreen-toggle-btn" class="modal-action-btn"><i class="fas fa-expand"></i></button>
                    </div>
				</div>
				<h2 class="text-2xl sm:text-3xl font-bold mb-4 text-white">${post.title}</h2>
				<div id="modal-media-container">
                    ${mediaHtml}
                </div>
				${modalYoutubeLinkHtml}
				<div class="mt-6 flex flex-wrap gap-2 text-gray-400 text-sm">
					<span><strong>Posted:</strong> ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A'}</span>
					<span><strong>Type:</strong> ${post.postType}</span>
					${post.postType === 'Devlog' && post.devlogType ? `<span><strong>Devlog Type:</strong> ${post.devlogType}</span>` : ''}
					${post.madeWith ? `<span><strong>Technologies Used:</strong> ${post.madeWith}</span>` : ''} <!-- Updated label -->
					<span><strong>AI Content:</strong> ${post.aiContent}</span>
					<span><strong>Views:</strong> ${formatNumberForDisplay(post.views || 0)}</span>
					${post.postType === 'HTML Game' ? `
						<span><strong>Plays:</strong> ${formatNumberForDisplay(post.visits || 0)}</span> <!-- Changed text -->
                        <span><strong>Compatibility:</strong> ${post.deviceCompatibility || 'Not specified'}</span> <!-- NEW -->
					` : ''}
                </div>
                <p class="text-gray-300 my-4 text-justify text-sm sm:text-base">${post.description}</p>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    ${post.postType === 'HTML Game' && post.genres && post.genres.length > 0 ? post.genres.map(g => `<span class="bg-blue-700 text-white text-xs font-semibold px-2 py-1 rounded-full">${g}</span>`).join('') : ''} <!-- Changed -->
                    ${post.tags && post.tags.length > 0 ? post.tags.map(t => `<span class="bg-purple-700 text-white text-xs font-semibold px-2 py-1 rounded-full">${t}</span>`).join('') : ''}
                </div>

                <div class="flex justify-center my-6 gap-4">
                    ${playGameButtonHtml} <!-- Play Game button -->
                    ${post.postType === 'Devlog' && post.linkedGamePromoId ? `
                        <button id="view-linked-game-btn" class="btn-primary flex items-center justify-center gap-2 px-4 py-2 sm:px-6 sm:py-3 rounded-md text-white font-bold hover:scale-105 transition-transform text-sm sm:text-base" data-linked-post-id="${post.linkedGamePromoId}">
                            <i class="fas fa-gamepad"></i> View Linked Game
                        </button>
                    ` : ''}
                </div>

                ${post.general ? `<div class="mt-4"><h3 class="font-semibold text-lg text-gray-200">General Info:</h3><p class="text-gray-300 text-sm sm:text-base">${post.general}</p></div>` : ''}
                ${post.reason ? `<div class="mt-4"><h3 class="font-semibold text-lg text-gray-200">Why I'm Posting:</h3><p class="text-gray-300 text-sm sm:text-base">${post.reason}</p></div>` : ''}

                ${pollHtml}

                ${post.allowComments !== false ? `
                    <div class="mt-8 border-t border-gray-700 pt-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-300">Comments (${formatNumberForDisplay(post.comments?.length || 0)})</h3>
                        <div id="comments-list" class="space-y-4 mb-6">
                            ${post.comments && post.comments.length > 0 ? post.comments.map((comment, index) => `
                                <div class="bg-[#1a1a1a] p-4 rounded-md shadow-sm">
                                    <p class="text-gray-300 text-sm sm:text-base">${comment.text}</p>
                                    <div class="flex justify-end items-center mt-2">
                                        ${post.authorId === currentUser?.uid ? `
                                            <button class="delete-comment-btn text-red-500 hover:text-red-400 transition ml-4" data-post-id="${postId}" data-comment-index="${index}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                        <p class="text-right text-xs text-gray-500 ml-auto">Comment by Anonymous on ${new Date(comment.timestamp.toDate()).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-400 text-sm sm:text-base">No comments yet. Be the first to leave feedback!</p>'}
                        </div>
                        <form id="comment-form" class="flex gap-2">
                            <input type="text" id="comment-input" class="flex-grow p-3 input-bg rounded-md text-sm sm:text-base" placeholder="Add a comment..." required>
                            <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded-md text-sm sm:text-base">Post</button>
                        </form>
                    </div>
                ` : `<div class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-400">Comments are disabled for this post.</div>`}
            `;
            postModal.classList.remove('hidden');
            if (userSettings.modalFullscreen) {
                toggleFullscreen(modalContent, true);
            }
            document.getElementById('close-modal-btn').addEventListener('click', closePostModal);
            document.getElementById('fullscreen-toggle-btn').addEventListener('click', () => toggleFullscreen(modalContent));
            
            // Add event listener for "Play Game" button to increment visits and launch dedicated game modal
            const playGameBtn = document.getElementById('play-game-btn');
            if (playGameBtn) {
                playGameBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (post.postType === 'HTML Game') {
                        try {
                            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                            await updateDoc(postRef, { visits: (post.visits || 0) + 1 });
                            post.visits = (post.visits || 0) + 1;
                            
                            // Open the dedicated game play modal, passing device compatibility
                            const gameSrcToLoad = playGameBtn.dataset.gameSrc; 
                            const deviceCompatibility = playGameBtn.dataset.deviceCompatibility; // NEW
                            openGamePlayModal(gameSrcToLoad, deviceCompatibility); // NEW

                        } catch (error) {
                            console.error("Error incrementing play count:", error);
                            showAlert(`Failed to track play: ${error.message || error}.`);
                        }
                    }
                });
            }

            // Add event listener for "View Linked Game" button
            const viewLinkedGameBtn = document.getElementById('view-linked-game-btn');
            if (viewLinkedGameBtn && post.linkedGamePromoId) {
                viewLinkedGameBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    closePostModal(); 
                    await openPostModal(e.currentTarget.dataset.linkedPostId, false, true);
                });
            }

            // Add event listener for the new custom YouTube link button
            const openVideoPlayerBtn = document.getElementById('open-video-player-btn');
            if (openVideoPlayerBtn) {
                openVideoPlayerBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const videoId = e.currentTarget.dataset.videoId;
                    if (videoId) {
                        openVideoModal(videoId);
                    } else {
                        showAlert("Video ID not found for playback.");
                    }
                });
            }

            // Add event listener for share button
            document.getElementById('share-post-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const shareLink = `https://htmlitweb.github.io/?postId=${postId}`; // Updated URL
                copyToClipboard(shareLink);
                showAlert("Link copied to clipboard!");
            });


            if (post.allowComments !== false) {
                document.getElementById('comment-form').addEventListener('submit', (e) => handleCommentSubmit(e, postId));
                document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                    btn.removeEventListener('click', (e) => { /* remove old listener */ });
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const commentIndex = parseInt(btn.dataset.commentIndex);
                        deleteComment(postId, commentIndex);
                    });
                });
                if (focusComment) {
                    document.getElementById('comment-input').focus();
                }
            }

            // Add event listeners for poll voting
            if ((post.postType === 'Devlog' && post.devlogType === 'Poll' && post.poll) || (post.postType === 'HTML Game' && post.poll)) { // Changed
                document.querySelectorAll('.vote-poll-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const optionIndex = parseInt(btn.dataset.optionIndex);
                        voteOnPoll(postId, optionIndex);
                    });
                });
            }
        }

        // Closes the post detail modal.
        function closePostModal() {
            postModal.classList.add('hidden');
            modalContent.innerHTML = '';
            editingPostId = null;
            isPostModalOpen = false;
            toggleFullscreen(modalContent, false);
            const postTypeSelect = document.getElementById('post-type');
            if (postTypeSelect) {
                postTypeSelect.disabled = false;
            }
            const url = new URL(window.location.href);
            url.searchParams.delete('postId');
            window.history.replaceState({}, document.title, url.toString());
        }

        // Handles the submission of a new comment for a post.
        async function handleCommentSubmit(e, postId) {
            e.preventDefault();
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete before commenting.");
                return;
            }
            const post = allFetchedPosts.find(p => p.id === postId);
            if (!post || post.allowComments === false) {
                showAlert("Comments are disabled for this post.");
                return;
            }

            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();

            if (!commentText) {
                showAlert("Comment cannot be empty.");
                return;
            }

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            
            const newComments = [...(post.comments || []), {
                authorId: currentUser.uid,
                text: commentText,
                timestamp: new Date(),
            }];

            try {
                await updateDoc(postRef, { comments: newComments });
                commentInput.value = '';
            } catch (error) {
                console.error("Error adding comment: ", error);
                showAlert(`Failed to post comment: ${error.message || error}.`);
            }
        }

        // Deletes a specific comment from a post.
        async function deleteComment(postId, commentIndex) {
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete.");
                return;
            }

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            const post = allFetchedPosts.find(p => p.id === postId);

            if (!post || !post.comments || commentIndex < 0 || commentIndex >= post.comments.length) {
                console.error("Comment not found for deletion:", postId, commentIndex);
                showAlert("Could not delete comment: Comment not found.");
                return;
            }

            if (post.authorId !== currentUser.uid) {
                showAlert("You can only delete comments on your own posts.");
                return;
            }

            const confirmed = await showConfirm("Are you sure you want to delete this comment? This cannot be undone.");
            if (!confirmed) {
                return;
            }

            const updatedComments = post.comments.filter((_, idx) => idx !== commentIndex);

            try {
                await updateDoc(postRef, { comments: updatedComments });
                showAlert("Comment deleted successfully.");
            } catch (error) {
                console.error("Error deleting comment:", error);
                showAlert(`Failed to delete comment: ${error.message || error}.`);
            }
        }

        // Handles voting on a poll within a Devlog or HTML Game.
        async function voteOnPoll(postId, optionIndex) {
            if (!currentUser || !isAuthReady) {
                showAlert("Please wait a moment for authentication to complete before voting.");
                return;
            }

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            const post = allFetchedPosts.find(p => p.id === postId);

            if (!post || !post.poll || optionIndex < 0 || optionIndex >= post.poll.options.length) {
                console.error("Poll or option not found for voting:", postId, optionIndex);
                showAlert("Could not cast vote: Poll or option not found.");
                return;
            }

            let currentPoll = post.poll;
            let newVoters = currentPoll.voters || [];

            if (newVoters.includes(currentUser.uid)) {
                showAlert("You have already voted on this poll.");
                return;
            }

            const updatedOptions = JSON.parse(JSON.stringify(currentPoll.options));
            updatedOptions[optionIndex].votes = (updatedOptions[optionIndex].votes || 0) + 1;
            newVoters.push(currentUser.uid);

            try {
                await updateDoc(postRef, {
                    'poll.options': updatedOptions,
                    'poll.voters': newVoters
                });
            } catch (error) {
                console.error("Error voting on poll:", error);
                showAlert(`Failed to cast vote: ${error.message || error}.`);
            }
        }


        // Function to copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textarea);
        }

    </script>
</body>
</html>
